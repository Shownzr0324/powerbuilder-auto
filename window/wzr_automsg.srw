$PBExportHeader$wzr_automsg.srw
forward
global type wzr_automsg from w_zjwlbase
end type
type dw_dstx from uo_datawindow within wzr_automsg
end type
type cb_dstx from uo_commandbutton within wzr_automsg
end type
type dw_zrr from uo_datawindow within wzr_automsg
end type
type dw_zrr1 from uo_datawindow within wzr_automsg
end type
type cb_kpiauto from uo_commandbutton within wzr_automsg
end type
type dw_szpf from uo_datawindow within wzr_automsg
end type
type dw_szpfall from uo_datawindow within wzr_automsg
end type
type dw_zbfjy from uo_datawindow within wzr_automsg
end type
type cb_insert from uo_commandbutton within wzr_automsg
end type
type dw_teacherkmadd from uo_datawindow within wzr_automsg
end type
type cb_teacheroec from uo_commandbutton within wzr_automsg
end type
type dw_oecclear from uo_datawindow within wzr_automsg
end type
type cb_gylfj from uo_commandbutton within wzr_automsg
end type
type dw_dzjxmx from uo_datawindow within wzr_automsg
end type
type dw_khdh from uo_datawindow within wzr_automsg
end type
type cb_dzmx from uo_commandbutton within wzr_automsg
end type
type dw_rzbh from uo_datawindow within wzr_automsg
end type
type cb_msdclvo from uo_commandbutton within wzr_automsg
end type
type cb_mspfjslvo from uo_commandbutton within wzr_automsg
end type
type dw_gszrr from uo_datawindow within wzr_automsg
end type
type dw_grzrr from uo_datawindow within wzr_automsg
end type
type dw_zbfjygr from uo_datawindow within wzr_automsg
end type
type dw_msry from uo_datawindow within wzr_automsg
end type
type cb_calsszq from uo_commandbutton within wzr_automsg
end type
type cb_xcxq from uo_commandbutton within wzr_automsg
end type
type cb_b2bdclv from uo_commandbutton within wzr_automsg
end type
type dw_b2bzp from uo_datawindow within wzr_automsg
end type
type dw_b2bhglv from uo_datawindow within wzr_automsg
end type
type cb_b2bhglv from uo_commandbutton within wzr_automsg
end type
type cb_zphglv from uo_commandbutton within wzr_automsg
end type
type dw_all from uo_datawindow within wzr_automsg
end type
type dw_bb from uo_datawindow within wzr_automsg
end type
type dw_zpbb from uo_datawindow within wzr_automsg
end type
type cb_szmt from uo_commandbutton within wzr_automsg
end type
type dw_szmt from uo_datawindow within wzr_automsg
end type
type cb_mtjl from commandbutton within wzr_automsg
end type
type dw_mtjl from uo_datawindow within wzr_automsg
end type
type cb_zpjhdclv from uo_commandbutton within wzr_automsg
end type
type dw_ryxq_zpbb from uo_datawindow within wzr_automsg
end type
type cb_gsbdbook from commandbutton within wzr_automsg
end type
type st_1 from statictext within wzr_automsg
end type
type st_2 from statictext within wzr_automsg
end type
type cb_zpjhjslv from uo_commandbutton within wzr_automsg
end type
type cb_oec from uo_commandbutton within wzr_automsg
end type
type dw_rzgjjxn from uo_datawindow within wzr_automsg
end type
type cb_rzgjjxn from uo_commandbutton within wzr_automsg
end type
type dw_zjjl from uo_datawindow within wzr_automsg
end type
type cb_zjjl from uo_commandbutton within wzr_automsg
end type
type st_3 from statictext within wzr_automsg
end type
type cb_rzgjwclv from uo_commandbutton within wzr_automsg
end type
type cb_rzgjjslv from uo_commandbutton within wzr_automsg
end type
type dw_classzq from uo_datawindow within wzr_automsg
end type
type cb_interviewwclv from uo_commandbutton within wzr_automsg
end type
type cb_czglhd from uo_commandbutton within wzr_automsg
end type
type dw_xmjcnr from uo_datawindow within wzr_automsg
end type
type st_4 from statictext within wzr_automsg
end type
type dw_hdflb from uo_datawindow within wzr_automsg
end type
type cb_lzgjwclv from uo_commandbutton within wzr_automsg
end type
type cb_lzgjjslv from uo_commandbutton within wzr_automsg
end type
type cb_gwydjslv from uo_commandbutton within wzr_automsg
end type
type cb_gwydwclv from uo_commandbutton within wzr_automsg
end type
type dw_bzbfjy from uo_datawindow within wzr_automsg
end type
type cb_mspfdclv from uo_commandbutton within wzr_automsg
end type
type cb_mspfjslv from uo_commandbutton within wzr_automsg
end type
type dw_oec from uo_datawindow within wzr_automsg
end type
type cb_meal from commandbutton within wzr_automsg
end type
type dw_meal from datawindow within wzr_automsg
end type
type dw_qxb from datawindow within wzr_automsg
end type
type st_5 from statictext within wzr_automsg
end type
type cb_rydx from uo_commandbutton within wzr_automsg
end type
type cb_rfm from uo_commandbutton within wzr_automsg
end type
type dw_rfm from datawindow within wzr_automsg
end type
type cb_1 from commandbutton within wzr_automsg
end type
type dw_customer from datawindow within wzr_automsg
end type
type cb_ygg from commandbutton within wzr_automsg
end type
type dw_ygg from datawindow within wzr_automsg
end type
type dw_menu from uo_datawindow within wzr_automsg
end type
type cb_2 from commandbutton within wzr_automsg
end type
type st_6 from statictext within wzr_automsg
end type
type cb_gwpgwclv from commandbutton within wzr_automsg
end type
type cb_xcszwclv from commandbutton within wzr_automsg
end type
type cb_gwxcgcfjlv from commandbutton within wzr_automsg
end type
type cb_3 from commandbutton within wzr_automsg
end type
type dw_1 from datawindow within wzr_automsg
end type
type uo_1 from uo_zip within wzr_automsg
end type
type cb_rzjdjslv from commandbutton within wzr_automsg
end type
type dw_jkdj from datawindow within wzr_automsg
end type
type cb_jkdj from commandbutton within wzr_automsg
end type
type dw_2 from datawindow within wzr_automsg
end type
type dw_3 from datawindow within wzr_automsg
end type
type cb_4 from commandbutton within wzr_automsg
end type
type cb_pxjhtz from commandbutton within wzr_automsg
end type
type dw_pxtz from datawindow within wzr_automsg
end type
end forward

global type wzr_automsg from w_zjwlbase
integer width = 6807
integer height = 3100
dw_dstx dw_dstx
cb_dstx cb_dstx
dw_zrr dw_zrr
dw_zrr1 dw_zrr1
cb_kpiauto cb_kpiauto
dw_szpf dw_szpf
dw_szpfall dw_szpfall
dw_zbfjy dw_zbfjy
cb_insert cb_insert
dw_teacherkmadd dw_teacherkmadd
cb_teacheroec cb_teacheroec
dw_oecclear dw_oecclear
cb_gylfj cb_gylfj
dw_dzjxmx dw_dzjxmx
dw_khdh dw_khdh
cb_dzmx cb_dzmx
dw_rzbh dw_rzbh
cb_msdclvo cb_msdclvo
cb_mspfjslvo cb_mspfjslvo
dw_gszrr dw_gszrr
dw_grzrr dw_grzrr
dw_zbfjygr dw_zbfjygr
dw_msry dw_msry
cb_calsszq cb_calsszq
cb_xcxq cb_xcxq
cb_b2bdclv cb_b2bdclv
dw_b2bzp dw_b2bzp
dw_b2bhglv dw_b2bhglv
cb_b2bhglv cb_b2bhglv
cb_zphglv cb_zphglv
dw_all dw_all
dw_bb dw_bb
dw_zpbb dw_zpbb
cb_szmt cb_szmt
dw_szmt dw_szmt
cb_mtjl cb_mtjl
dw_mtjl dw_mtjl
cb_zpjhdclv cb_zpjhdclv
dw_ryxq_zpbb dw_ryxq_zpbb
cb_gsbdbook cb_gsbdbook
st_1 st_1
st_2 st_2
cb_zpjhjslv cb_zpjhjslv
cb_oec cb_oec
dw_rzgjjxn dw_rzgjjxn
cb_rzgjjxn cb_rzgjjxn
dw_zjjl dw_zjjl
cb_zjjl cb_zjjl
st_3 st_3
cb_rzgjwclv cb_rzgjwclv
cb_rzgjjslv cb_rzgjjslv
dw_classzq dw_classzq
cb_interviewwclv cb_interviewwclv
cb_czglhd cb_czglhd
dw_xmjcnr dw_xmjcnr
st_4 st_4
dw_hdflb dw_hdflb
cb_lzgjwclv cb_lzgjwclv
cb_lzgjjslv cb_lzgjjslv
cb_gwydjslv cb_gwydjslv
cb_gwydwclv cb_gwydwclv
dw_bzbfjy dw_bzbfjy
cb_mspfdclv cb_mspfdclv
cb_mspfjslv cb_mspfjslv
dw_oec dw_oec
cb_meal cb_meal
dw_meal dw_meal
dw_qxb dw_qxb
st_5 st_5
cb_rydx cb_rydx
cb_rfm cb_rfm
dw_rfm dw_rfm
cb_1 cb_1
dw_customer dw_customer
cb_ygg cb_ygg
dw_ygg dw_ygg
dw_menu dw_menu
cb_2 cb_2
st_6 st_6
cb_gwpgwclv cb_gwpgwclv
cb_xcszwclv cb_xcszwclv
cb_gwxcgcfjlv cb_gwxcgcfjlv
cb_3 cb_3
dw_1 dw_1
uo_1 uo_1
cb_rzjdjslv cb_rzjdjslv
dw_jkdj dw_jkdj
cb_jkdj cb_jkdj
dw_2 dw_2
dw_3 dw_3
cb_4 cb_4
cb_pxjhtz cb_pxjhtz
dw_pxtz dw_pxtz
end type
global wzr_automsg wzr_automsg

type variables
datetime idt_mid
string bxtime[]
nvo_ftp n_ftp
end variables

forward prototypes
public function string getname (string ls_ygid)
public subroutine f_setlx (string as_khdh, long al_jkzq)
public subroutine f_getkpi (ref datetime ldt_start, ref datetime ldt_end, ref long month)
public subroutine f_auto (integer i)
public subroutine f_ygqx (string ls_today)
public subroutine f_getmid ()
public function string f_midtime (datastore dw)
public subroutine f_mealerroperson (long al_f)
public subroutine f_inslog (string ygid, datetime insdate, datetime starttime, datetime endtime, string content)
end prototypes

public function string getname (string ls_ygid);string ls_name
select ygxm into :ls_name from kh_use where ygid = :ls_ygid;
return ls_name
end function

public subroutine f_setlx (string as_khdh, long al_jkzq);//每日刷新利息
long ll_row,i,ll_guishu
datetime ldt_zxr,ldt_qxr
date ld_qxr,ld_today,ld_zxr
dec ldc_total,ldc_lx,ldc_yslx
dec{2} ldc_jgf
ll_row = dw_dzjxmx.retrieve(as_khdh)
select sum(lx) into :ldc_yslx  from r_gyl_dzjxmx where khdh = :as_khdh and jz_bz = '1' and (sk_bz = '0' );
select jgf into :ldc_jgf from r_gyl_yszmx where khdh = :as_khdh;
select guishu into :ll_guishu from khmain where khdh = :as_khdh;
if ll_row > 0 then
for i = 1 to ll_row
	ldt_zxr = dw_dzjxmx.object.zxr[i]
	ld_zxr = date(ldt_zxr)
	ldt_qxr = dw_dzjxmx.object.qxr[i]
	ldc_total = dw_dzjxmx.object.jx_money[i]
	ldc_lx = dw_dzjxmx.object.date_ll[i]
	ld_qxr = date(ldt_qxr)
	ld_today = today()
	dw_dzjxmx.object.yslx[i] = ldc_yslx
	if isnull(ldt_zxr)  then
		dw_dzjxmx.object.ts[i] = ((daysafter(ld_qxr,ld_today))+1)
		dw_dzjxmx.object.lx[i] = (ldc_total*ldc_lx*((daysafter(ld_qxr,ld_today))+1))/100
	else
		dw_dzjxmx.object.ts[i] = ((daysafter(ld_qxr,ld_zxr))+1)
		dw_dzjxmx.object.lx[i] = (ldc_total*ldc_lx*((daysafter(ld_qxr,ld_zxr))+1))/100
	end if
	
	//监管费
	long ll_yqts,ll_n  //逾期天数
	dec{2} ldc_new
	if dw_dzjxmx.object.sk_bz[i] <> '1' and dw_dzjxmx.object.ts[i] > al_jkzq then
		ll_yqts = dw_dzjxmx.object.ts[i] - al_jkzq
		if mod(ll_yqts,30) = 0 then
			ll_n = ll_yqts/30
		else
			ll_n = ll_yqts/30 + 1
		end if
		ldc_new = ll_n*ll_guishu*ldc_jgf
		dw_dzjxmx.object.jgf[i] = ldc_new
	end if
next
end if
f_save(dw_dzjxmx)
end subroutine

public subroutine f_getkpi (ref datetime ldt_start, ref datetime ldt_end, ref long month);/**计算绩效月**/
long day,year_start,year_end,month_start,month_end
day = day(today())
if day <= 20 then
	month = month(today())
	month_start = month - 1 
	month_end = month 
else
	if month(today()) = 12 then
		month = 1
		month_start = 12
		month_end = 1
	else
		month = month(today()) + 1
		month_start = month(today())
		month_end = month
	end if
end if

if month = 1 then
	month_start = 12
	if month(today()) = 12 then
		year_start = year(today())
	else
		year_start = year(today()) - 1
	end if
	year_end = year_start + 1
else
	year_start = year(today())
	year_end = year(today())
end if
ldt_start = datetime(date(string(year_start) + '/' + string(month_start,'00') + '/21'),time('00:00:00'))
ldt_end = datetime(date(string(year_end) + '/' + string(month_end,'00') + '/20'),time('00:00:00'))

end subroutine

public subroutine f_auto (integer i);long year,month,day
string ls_d
date ldt_d
datetime ldt_qs
if dw_classzq.rowcount() < 1 then 
	messagebox(gs_messagebox_title,"请先生成对应培训周期！")
	return
end if
year = year(date(dw_classzq.object.qssj[i])) + 1
month = month(date(dw_classzq.object.qssj[i]))
day = day(date(dw_classzq.object.qssj[i]))
ls_d = string(year) + '/' + string(month,'00') + '/' + string(day,'00')
ldt_d = date(ls_d)
ldt_qs = datetime(ldt_d,now())
dw_classzq.object.qssj[i] = ldt_qs

year = year(date(dw_classzq.object.jssj[i])) + 1
month = month(date(dw_classzq.object.jssj[i]))
day = day(date(dw_classzq.object.jssj[i]))
ls_d = string(year) + '/' + string(month,'00') + '/' + string(day,'00')
ldt_d = date(ls_d)
ldt_qs = datetime(ldt_d,now())
dw_classzq.object.jssj[i] = ldt_qs

year = year(date(dw_classzq.object.yxqssj[i])) + 1
month = month(date(dw_classzq.object.yxqssj[i]))
day = day(date(dw_classzq.object.yxqssj[i]))
ls_d = string(year) + '/' + string(month,'00') + '/' + string(day,'00')
ldt_d = date(ls_d)
ldt_qs = datetime(ldt_d,now())
dw_classzq.object.yxqssj[i] = ldt_qs

year = year(date(dw_classzq.object.yxjssj[i])) + 1
month = month(date(dw_classzq.object.yxjssj[i]))
day = day(date(dw_classzq.object.yxjssj[i]))
ls_d = string(year) + '/' + string(month,'00') + '/' + string(day,'00')
ldt_d = date(ls_d)
ldt_qs = datetime(ldt_d,now())
dw_classzq.object.yxjssj[i] = ldt_qs


end subroutine

public subroutine f_ygqx (string ls_today);long year,month,day,sum,zc,wc,i,k,row,ll_rowcount,ll_daynum
ll_daynum = daynumber(date(ls_today))//星期天是1 星期六是7
ll_rowcount=dw_qxb.retrieve(ls_today)
year = long(left(ls_today,4))
month = long(mid(ls_today,6,2))
day = long(right(ls_today,2))

//select sum(zc), sum(wc)
//into:zc,:wc from kq2bz
//where CONVERT(varchar(100),rq, 23)=:ls_today;

dw_qxb.SetSort("deptid A,zf desc,wf desc,ygid asc")
dw_qxb.Sort()


select sum into :sum from r_xsg_eat where year = :year and month = :month and day = :day;
for row=1 to dw_qxb.rowcount()
	dw_qxb.object.ebz_lunch[row]=sum
	dw_qxb.object.i[row]=0
	dw_qxb.object.k[row]=0
//	dw_qxb.object.ebz_lunch[row]=sum
//	dw_qxb.object.ebz_lunch[row]=sum
next

select sum(zc),sum(wc) into :i,:k from kq2bz where CONVERT(varchar(100),rq, 23) = :ls_today;
dw_qxb.object.i[1]=i
dw_qxb.object.k[1]=k


datastore rylook_ccd
rylook_ccd=create datastore
rylook_ccd.dataobject="dwnuo_rylook_ccd"
rylook_ccd.settransobject(sqlca)
rylook_ccd.retrieve(ls_today)//关联出差单

datastore rylook_ygqxbj
rylook_ygqxbj=create datastore
rylook_ygqxbj.dataobject="dwnuo_rylook_ygqxbj"
rylook_ygqxbj.settransobject(sqlca)
rylook_ygqxbj.retrieve(ls_today)//员工勾选记录

long ll_row
for row=1 to dw_qxb.rowcount()
	string ls_txt,ls_sw,ls_xw,ls_ygid,ls_today1,ls_today2
	ls_ygid=dw_qxb.object.ygid[row]

	string ls_lx,ls_mc
	ls_lx=""
	datetime sjhcsj,sjcfsj
	decimal ld_sjts
	ll_row=0
	ll_row=rylook_ccd.find("ccr='"+ls_ygid+"'",1,rylook_ccd.rowcount())
	if ll_row > 0 then
		ls_lx=rylook_ccd.object.lx[ll_row]
		ls_mc=rylook_ccd.object.mc[ll_row]
		ld_sjts=rylook_ccd.object.sjts[ll_row]
		sjhcsj=rylook_ccd.object.sjhcsj[ll_row]
		sjcfsj=rylook_ccd.object.sjcfsj[ll_row]
		ls_today1=string(sjcfsj,"yyyy-mm-dd")
		ls_today2=string(sjhcsj,"yyyy-mm-dd")
		string time1,time2
		time1=string(sjcfsj,"hh:mm:ss")
		time2=string(sjhcsj,"hh:mm:ss")
		long sx,ll_sjts
		ll_sjts=long(ld_sjts)
		sx=0//全天
		if time1 >="12:00:00" and ls_today1=ls_today then sx=2//下午
		if time2 <="12:00:00" and time2 >"00:00:00" and ls_today2=ls_today then sx=1//上午
		long ll_cf,t
		string ls_zt
		ls_zt=""
		choose case ls_lx
			case "03"
				ls_zt="申请请假"
			case "08"
				ls_zt="申请培训"
			case "10"
				ls_zt="申请活动"
			case "07"
				ls_zt="申请年休"
			case "06"
				ls_zt="申请出差"
			case "20"
				ls_zt="申请工伤"
			case "13"
				ls_zt="申请婚假"
			case "14"
				ls_zt="申请产假"
			case "15"
				ls_zt="申请哺乳"
			case "16"
				ls_zt="申请丧假"
			case "24"
				ls_zt="申请隔离"
			case "04","21"
				ls_zt="申请调休"
		end choose
		
		if len(ls_zt) > 0 then
			if sx=0 or sx=1 then 
				dw_qxb.object.sw[row]=ls_zt
				dw_qxb.object.zf[row]=0
			end if
			if sx=0 or sx=2 then 
				dw_qxb.object.xw[row]=ls_zt
				dw_qxb.object.wf[row]=0
			end if
			dw_qxb.object.zgzt[row]=ls_zt
			dw_qxb.object.zxbz[row]=0
			
			if ls_lx='11' or ls_lx='23' then//11加班单，23单上单，需要吃饭，
				if sx=0 or sx=1 then 
					dw_qxb.object.zf[row]=1
				end if
				if sx=0 or sx=2 then 
					dw_qxb.object.wf[row]=1
				end if
			end if
		end if
	end if
	
	//关联人员手工勾选状态
	ll_row=0
	ll_row=rylook_ygqxbj.find("(ygid='"+ls_ygid+"') and (lx=1)",1,rylook_ygqxbj.rowcount())
	if ll_row > 0 then
		dw_qxb.object.zf[row]=rylook_ygqxbj.object.zt[ll_row]
	end if
	ll_row=0
	ll_row=rylook_ygqxbj.find("(ygid='"+ls_ygid+"') and (lx=2)",1,rylook_ygqxbj.rowcount())
	if ll_row > 0 then
		dw_qxb.object.wf[row]=rylook_ygqxbj.object.zt[ll_row]
	end if	
next
destroy rylook_ygqxbj
destroy rylook_ccd
end subroutine

public subroutine f_getmid ();
end subroutine

public function string f_midtime (datastore dw);string ls_mid
if dw.rowcount() > 0 then
	datetime ldt_max,ldt_list[]
	long i,c = 0
	for i = 1 to dw.rowcount()
		if i = 1 then
			ldt_max = dw.object.latest_time[i]
		else
			if dw.object.latest_time[i]  >= ldt_max then
				ldt_max = dw.object.latest_time[i] 
			else
				c++
				ldt_list[c] = dw.object.latest_time[i]
			end if
		end if
	next
	ldt_list[c+1] = ldt_max
	if mod(upperbound(ldt_list),2) = 0 then
		idt_mid = ldt_list[upperbound(ldt_list)/2]
	else
		idt_mid = ldt_list[upperbound(ldt_list)/2 + 1]
	end if
	ls_mid = string(idt_mid,'yyyy-mm-dd')
end if
return ls_mid
end function

public subroutine f_mealerroperson (long al_f);string ls_person,ls_person1,ls_date
long i
ls_person = ''
ls_person1 = ''
ls_date = string(today(),'yyyy-mm-dd')
datastore dst
dst = create datastore
dst.dataobject ='dwn_ygqxb'
dst.settransobject(sqlca)
dst.retrieve(ls_date)
dw_menu.retrieve()
for i = 1 to dst.rowcount()
	if al_f = 1 then //中午
		if dst.object.zf[i] = 1 and isnull(dst.object.lunch_time[i]) then
			ls_person = ls_person + dst.describe("Evaluate('LookupDisplay(ygid)',"+string(i)+")") + ","
		end if
	else //晚上
		if dst.object.wf[i] = 1 and isnull(dst.object.dinner_time[i]) then
			ls_person1 = ls_person1 + dst.describe("Evaluate('LookupDisplay(ygid)',"+string(i)+")")+ ","
		end if
	end if
next
long ll_find,ll_find1
ll_find = dw_menu.find("meal = '1' and string(rq,'yyyy-mm-dd') = '" + ls_date + "'",1,dw_menu.rowcount())
ll_find1 = dw_menu.find("meal = '2' and string(rq,'yyyy-mm-dd') = '" + ls_date + "'",1,dw_menu.rowcount())
if ll_find > 0 and al_f = 1 then
	dw_menu.object.error_persons[ll_find] = ls_person
end if
if ll_find1 > 0 and al_f = 0 then
	dw_menu.object.error_persons[ll_find1] = ls_person1
end if
f_save(dw_menu)
end subroutine

public subroutine f_inslog (string ygid, datetime insdate, datetime starttime, datetime endtime, string content);long ll_xh
string ls_bh
select max(xh) into :ll_xh from jxjjgl where rq = :insdate and ygid = :ygid;
if isnull(ll_xh) then
	ll_xh = 1 
else
	ll_xh = ll_xh + 1
end if
ls_bh = string(insdate,"yyyymmdd") + ygid + string(ll_xh)
INSERT INTO jxjjgl(qsj,zsj,jrsx,rq,ygid,xh,wc,tdrq,bh,bhbj)
VALUES (:starttime,:endtime,:content,:insdate,:ygid,:ll_xh,"0",:insdate,:ls_bh,"0");
fc_sqlcode0()
end subroutine

event open;call super::open;long ll_start,ll_end
datetime ldt_today
ll_start=cpu()
ll_end=cpu()
f_mkjr("F0541","自动程序szr","wzr_automsg",(ll_End - il_Start)/1000)
timer(60)
ldt_today = datetime(date(string(today(),"yyyy-mm-dd")),time("00:00:00"))



end event

on wzr_automsg.create
int iCurrent
call super::create
this.dw_dstx=create dw_dstx
this.cb_dstx=create cb_dstx
this.dw_zrr=create dw_zrr
this.dw_zrr1=create dw_zrr1
this.cb_kpiauto=create cb_kpiauto
this.dw_szpf=create dw_szpf
this.dw_szpfall=create dw_szpfall
this.dw_zbfjy=create dw_zbfjy
this.cb_insert=create cb_insert
this.dw_teacherkmadd=create dw_teacherkmadd
this.cb_teacheroec=create cb_teacheroec
this.dw_oecclear=create dw_oecclear
this.cb_gylfj=create cb_gylfj
this.dw_dzjxmx=create dw_dzjxmx
this.dw_khdh=create dw_khdh
this.cb_dzmx=create cb_dzmx
this.dw_rzbh=create dw_rzbh
this.cb_msdclvo=create cb_msdclvo
this.cb_mspfjslvo=create cb_mspfjslvo
this.dw_gszrr=create dw_gszrr
this.dw_grzrr=create dw_grzrr
this.dw_zbfjygr=create dw_zbfjygr
this.dw_msry=create dw_msry
this.cb_calsszq=create cb_calsszq
this.cb_xcxq=create cb_xcxq
this.cb_b2bdclv=create cb_b2bdclv
this.dw_b2bzp=create dw_b2bzp
this.dw_b2bhglv=create dw_b2bhglv
this.cb_b2bhglv=create cb_b2bhglv
this.cb_zphglv=create cb_zphglv
this.dw_all=create dw_all
this.dw_bb=create dw_bb
this.dw_zpbb=create dw_zpbb
this.cb_szmt=create cb_szmt
this.dw_szmt=create dw_szmt
this.cb_mtjl=create cb_mtjl
this.dw_mtjl=create dw_mtjl
this.cb_zpjhdclv=create cb_zpjhdclv
this.dw_ryxq_zpbb=create dw_ryxq_zpbb
this.cb_gsbdbook=create cb_gsbdbook
this.st_1=create st_1
this.st_2=create st_2
this.cb_zpjhjslv=create cb_zpjhjslv
this.cb_oec=create cb_oec
this.dw_rzgjjxn=create dw_rzgjjxn
this.cb_rzgjjxn=create cb_rzgjjxn
this.dw_zjjl=create dw_zjjl
this.cb_zjjl=create cb_zjjl
this.st_3=create st_3
this.cb_rzgjwclv=create cb_rzgjwclv
this.cb_rzgjjslv=create cb_rzgjjslv
this.dw_classzq=create dw_classzq
this.cb_interviewwclv=create cb_interviewwclv
this.cb_czglhd=create cb_czglhd
this.dw_xmjcnr=create dw_xmjcnr
this.st_4=create st_4
this.dw_hdflb=create dw_hdflb
this.cb_lzgjwclv=create cb_lzgjwclv
this.cb_lzgjjslv=create cb_lzgjjslv
this.cb_gwydjslv=create cb_gwydjslv
this.cb_gwydwclv=create cb_gwydwclv
this.dw_bzbfjy=create dw_bzbfjy
this.cb_mspfdclv=create cb_mspfdclv
this.cb_mspfjslv=create cb_mspfjslv
this.dw_oec=create dw_oec
this.cb_meal=create cb_meal
this.dw_meal=create dw_meal
this.dw_qxb=create dw_qxb
this.st_5=create st_5
this.cb_rydx=create cb_rydx
this.cb_rfm=create cb_rfm
this.dw_rfm=create dw_rfm
this.cb_1=create cb_1
this.dw_customer=create dw_customer
this.cb_ygg=create cb_ygg
this.dw_ygg=create dw_ygg
this.dw_menu=create dw_menu
this.cb_2=create cb_2
this.st_6=create st_6
this.cb_gwpgwclv=create cb_gwpgwclv
this.cb_xcszwclv=create cb_xcszwclv
this.cb_gwxcgcfjlv=create cb_gwxcgcfjlv
this.cb_3=create cb_3
this.dw_1=create dw_1
this.uo_1=create uo_1
this.cb_rzjdjslv=create cb_rzjdjslv
this.dw_jkdj=create dw_jkdj
this.cb_jkdj=create cb_jkdj
this.dw_2=create dw_2
this.dw_3=create dw_3
this.cb_4=create cb_4
this.cb_pxjhtz=create cb_pxjhtz
this.dw_pxtz=create dw_pxtz
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.dw_dstx
this.Control[iCurrent+2]=this.cb_dstx
this.Control[iCurrent+3]=this.dw_zrr
this.Control[iCurrent+4]=this.dw_zrr1
this.Control[iCurrent+5]=this.cb_kpiauto
this.Control[iCurrent+6]=this.dw_szpf
this.Control[iCurrent+7]=this.dw_szpfall
this.Control[iCurrent+8]=this.dw_zbfjy
this.Control[iCurrent+9]=this.cb_insert
this.Control[iCurrent+10]=this.dw_teacherkmadd
this.Control[iCurrent+11]=this.cb_teacheroec
this.Control[iCurrent+12]=this.dw_oecclear
this.Control[iCurrent+13]=this.cb_gylfj
this.Control[iCurrent+14]=this.dw_dzjxmx
this.Control[iCurrent+15]=this.dw_khdh
this.Control[iCurrent+16]=this.cb_dzmx
this.Control[iCurrent+17]=this.dw_rzbh
this.Control[iCurrent+18]=this.cb_msdclvo
this.Control[iCurrent+19]=this.cb_mspfjslvo
this.Control[iCurrent+20]=this.dw_gszrr
this.Control[iCurrent+21]=this.dw_grzrr
this.Control[iCurrent+22]=this.dw_zbfjygr
this.Control[iCurrent+23]=this.dw_msry
this.Control[iCurrent+24]=this.cb_calsszq
this.Control[iCurrent+25]=this.cb_xcxq
this.Control[iCurrent+26]=this.cb_b2bdclv
this.Control[iCurrent+27]=this.dw_b2bzp
this.Control[iCurrent+28]=this.dw_b2bhglv
this.Control[iCurrent+29]=this.cb_b2bhglv
this.Control[iCurrent+30]=this.cb_zphglv
this.Control[iCurrent+31]=this.dw_all
this.Control[iCurrent+32]=this.dw_bb
this.Control[iCurrent+33]=this.dw_zpbb
this.Control[iCurrent+34]=this.cb_szmt
this.Control[iCurrent+35]=this.dw_szmt
this.Control[iCurrent+36]=this.cb_mtjl
this.Control[iCurrent+37]=this.dw_mtjl
this.Control[iCurrent+38]=this.cb_zpjhdclv
this.Control[iCurrent+39]=this.dw_ryxq_zpbb
this.Control[iCurrent+40]=this.cb_gsbdbook
this.Control[iCurrent+41]=this.st_1
this.Control[iCurrent+42]=this.st_2
this.Control[iCurrent+43]=this.cb_zpjhjslv
this.Control[iCurrent+44]=this.cb_oec
this.Control[iCurrent+45]=this.dw_rzgjjxn
this.Control[iCurrent+46]=this.cb_rzgjjxn
this.Control[iCurrent+47]=this.dw_zjjl
this.Control[iCurrent+48]=this.cb_zjjl
this.Control[iCurrent+49]=this.st_3
this.Control[iCurrent+50]=this.cb_rzgjwclv
this.Control[iCurrent+51]=this.cb_rzgjjslv
this.Control[iCurrent+52]=this.dw_classzq
this.Control[iCurrent+53]=this.cb_interviewwclv
this.Control[iCurrent+54]=this.cb_czglhd
this.Control[iCurrent+55]=this.dw_xmjcnr
this.Control[iCurrent+56]=this.st_4
this.Control[iCurrent+57]=this.dw_hdflb
this.Control[iCurrent+58]=this.cb_lzgjwclv
this.Control[iCurrent+59]=this.cb_lzgjjslv
this.Control[iCurrent+60]=this.cb_gwydjslv
this.Control[iCurrent+61]=this.cb_gwydwclv
this.Control[iCurrent+62]=this.dw_bzbfjy
this.Control[iCurrent+63]=this.cb_mspfdclv
this.Control[iCurrent+64]=this.cb_mspfjslv
this.Control[iCurrent+65]=this.dw_oec
this.Control[iCurrent+66]=this.cb_meal
this.Control[iCurrent+67]=this.dw_meal
this.Control[iCurrent+68]=this.dw_qxb
this.Control[iCurrent+69]=this.st_5
this.Control[iCurrent+70]=this.cb_rydx
this.Control[iCurrent+71]=this.cb_rfm
this.Control[iCurrent+72]=this.dw_rfm
this.Control[iCurrent+73]=this.cb_1
this.Control[iCurrent+74]=this.dw_customer
this.Control[iCurrent+75]=this.cb_ygg
this.Control[iCurrent+76]=this.dw_ygg
this.Control[iCurrent+77]=this.dw_menu
this.Control[iCurrent+78]=this.cb_2
this.Control[iCurrent+79]=this.st_6
this.Control[iCurrent+80]=this.cb_gwpgwclv
this.Control[iCurrent+81]=this.cb_xcszwclv
this.Control[iCurrent+82]=this.cb_gwxcgcfjlv
this.Control[iCurrent+83]=this.cb_3
this.Control[iCurrent+84]=this.dw_1
this.Control[iCurrent+85]=this.uo_1
this.Control[iCurrent+86]=this.cb_rzjdjslv
this.Control[iCurrent+87]=this.dw_jkdj
this.Control[iCurrent+88]=this.cb_jkdj
this.Control[iCurrent+89]=this.dw_2
this.Control[iCurrent+90]=this.dw_3
this.Control[iCurrent+91]=this.cb_4
this.Control[iCurrent+92]=this.cb_pxjhtz
this.Control[iCurrent+93]=this.dw_pxtz
end on

on wzr_automsg.destroy
call super::destroy
destroy(this.dw_dstx)
destroy(this.cb_dstx)
destroy(this.dw_zrr)
destroy(this.dw_zrr1)
destroy(this.cb_kpiauto)
destroy(this.dw_szpf)
destroy(this.dw_szpfall)
destroy(this.dw_zbfjy)
destroy(this.cb_insert)
destroy(this.dw_teacherkmadd)
destroy(this.cb_teacheroec)
destroy(this.dw_oecclear)
destroy(this.cb_gylfj)
destroy(this.dw_dzjxmx)
destroy(this.dw_khdh)
destroy(this.cb_dzmx)
destroy(this.dw_rzbh)
destroy(this.cb_msdclvo)
destroy(this.cb_mspfjslvo)
destroy(this.dw_gszrr)
destroy(this.dw_grzrr)
destroy(this.dw_zbfjygr)
destroy(this.dw_msry)
destroy(this.cb_calsszq)
destroy(this.cb_xcxq)
destroy(this.cb_b2bdclv)
destroy(this.dw_b2bzp)
destroy(this.dw_b2bhglv)
destroy(this.cb_b2bhglv)
destroy(this.cb_zphglv)
destroy(this.dw_all)
destroy(this.dw_bb)
destroy(this.dw_zpbb)
destroy(this.cb_szmt)
destroy(this.dw_szmt)
destroy(this.cb_mtjl)
destroy(this.dw_mtjl)
destroy(this.cb_zpjhdclv)
destroy(this.dw_ryxq_zpbb)
destroy(this.cb_gsbdbook)
destroy(this.st_1)
destroy(this.st_2)
destroy(this.cb_zpjhjslv)
destroy(this.cb_oec)
destroy(this.dw_rzgjjxn)
destroy(this.cb_rzgjjxn)
destroy(this.dw_zjjl)
destroy(this.cb_zjjl)
destroy(this.st_3)
destroy(this.cb_rzgjwclv)
destroy(this.cb_rzgjjslv)
destroy(this.dw_classzq)
destroy(this.cb_interviewwclv)
destroy(this.cb_czglhd)
destroy(this.dw_xmjcnr)
destroy(this.st_4)
destroy(this.dw_hdflb)
destroy(this.cb_lzgjwclv)
destroy(this.cb_lzgjjslv)
destroy(this.cb_gwydjslv)
destroy(this.cb_gwydwclv)
destroy(this.dw_bzbfjy)
destroy(this.cb_mspfdclv)
destroy(this.cb_mspfjslv)
destroy(this.dw_oec)
destroy(this.cb_meal)
destroy(this.dw_meal)
destroy(this.dw_qxb)
destroy(this.st_5)
destroy(this.cb_rydx)
destroy(this.cb_rfm)
destroy(this.dw_rfm)
destroy(this.cb_1)
destroy(this.dw_customer)
destroy(this.cb_ygg)
destroy(this.dw_ygg)
destroy(this.dw_menu)
destroy(this.cb_2)
destroy(this.st_6)
destroy(this.cb_gwpgwclv)
destroy(this.cb_xcszwclv)
destroy(this.cb_gwxcgcfjlv)
destroy(this.cb_3)
destroy(this.dw_1)
destroy(this.uo_1)
destroy(this.cb_rzjdjslv)
destroy(this.dw_jkdj)
destroy(this.cb_jkdj)
destroy(this.dw_2)
destroy(this.dw_3)
destroy(this.cb_4)
destroy(this.cb_pxjhtz)
destroy(this.dw_pxtz)
end on

event timer;call super::timer;string ls_time,ls_date
ls_date = string(day(today()))
ls_time = string(now(),'hh:mm')
if ls_time = '03:45' or ls_time = '04:55' or ls_time = '05:15' or ls_time = '08:00' or ls_time = '06:40' or ls_time = '18:25' or ls_time = '14:55' or ls_time = '12:55' then
	restart()
end if
//if ls_time = '03:50' then
if ls_time = '08:50' then	
//	cb_dzmx.triggerevent(clicked!)
//	cb_mspfdclv.triggerevent(clicked!)
//	cb_mspfjslv.triggerevent(clicked!)
//	cb_b2bdclv.triggerevent(clicked!) //b2b招聘计划达成率
//	cb_b2bhglv.triggerevent(clicked!) //招聘人才合格率
//	cb_zphglv.triggerevent(clicked!)
	cb_szmt.triggerevent(clicked!)
	cb_zpjhdclv.triggerevent(clicked!)//招聘计划达成率
	cb_zpjhjslv.triggerevent(clicked!)//招聘及时率
	cb_rzgjjxn.triggerevent(clicked!)//入职跟进绩效能
	cb_rzgjwclv.triggerevent(clicked!)//入职跟进人员入职跟进完成率
	cb_rzgjjslv.triggerevent(clicked!)//入职跟进人员入职跟进及时率
	cb_interviewwclv.triggerevent(clicked!)//新员工面谈问题反馈处理完成率
	cb_lzgjwclv.triggerevent(clicked!)//入职跟进人员离职跟进完成率
	cb_lzgjjslv.triggerevent(clicked!)//入职跟进人员离职跟进及时率
	cb_gwydwclv.triggerevent(clicked!)//岗位异动跟进完成率
	cb_gwydjslv.triggerevent(clicked!)//岗位异动跟进及时率
	cb_rydx.triggerevent(clicked!)//人员定薪审核绩效能
	cb_gwpgwclv.triggerevent(clicked!)//岗位评估完成率
	cb_gwxcgcfjlv.triggerevent(clicked!)//岗位薪酬构成分解率
	cb_xcszwclv.triggerevent(clicked!)//薪酬设置完成率
	cb_rzjdjslv.triggerevent(clicked!)//任职基数鉴定及时率
end if

if ls_time = '05:20' then
	cb_rfm.triggerevent(clicked!)
end if

if ls_time = '05:00' then
	cb_mtjl.triggerevent(clicked!)//周招聘面谈记录表
	//cb_1.triggerevent(clicked!)
	//cb_2.triggerevent(clicked!)
	if ls_date = '1' then
		cb_ygg.triggerevent(clicked!)
	end if
end if

if ls_time = '08:30' then
	cb_meal.triggerevent(clicked!)
	cb_teacheroec.triggerevent(clicked!)
	//cb_dstx.triggerevent(clicked!)
end if


if ls_time = '13:00' then
	cb_meal.triggerevent(clicked!)
end if

if ls_time = '15:00' then
	cb_meal.triggerevent(clicked!)
end if

if ls_time = '08:40' then
	cb_gsbdbook.triggerevent(clicked!)//新员工公司必读书籍下达
	cb_zjjl.triggerevent(clicked!) //证件短信提醒办件
	cb_jkdj.triggerevent(clicked!)//进口管理定价单失效提醒
end if

if ls_time = '06:55' and ls_date = '20' then
	cb_kpiauto.triggerevent(clicked!)
end if

if ls_time = '08:50' and ls_date = '21' then
	cb_calsszq.triggerevent(clicked!)
end if

if ls_time = '18:30' then
	cb_xcxq.triggerevent(clicked!)
	cb_meal.triggerevent(clicked!)
end if

if ls_time = '17:20' then
	cb_oec.triggerevent(clicked!)
end if
end event

type dw_title from w_zjwlbase`dw_title within wzr_automsg
end type

type dw_dstx from uo_datawindow within wzr_automsg
integer x = 27
integer y = 172
integer width = 709
integer height = 440
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_wlgl_dstx1"
end type

type cb_dstx from uo_commandbutton within wzr_automsg
integer x = 73
integer y = 44
integer width = 494
integer height = 92
integer taborder = 20
boolean bringtotop = true
string text = "物料管理定时提醒"
end type

event clicked;call super::clicked;dw_dstx.retrieve()
long i,sjjsfs,dsrq,yue
long rq,yf
string ls_wlmc,ls_zrr
string ls_ygid,ls_ygxm,ls_ygdh,ls_sms
rq = day(today())
yf = month(today())
for i = 1 to dw_dstx.rowcount()
	sjjsfs = dw_dstx.object.sjjsfs[i]
	dsrq = dw_dstx.object.dsrq[i]
	yue = dw_dstx.object.yue[i]
	ls_wlmc = dw_dstx.object.wlmc[i]
	ls_zrr = dw_dstx.object.zrr[i]
	choose case sjjsfs
		case 1
			if rq = dsrq then
				ls_ygxm = getname(ls_zrr)
				ls_sms="您好"+ ls_ygxm + "," + ls_wlmc +"需要进行维护!" +string(today(),'yyyy-mm-dd')
				ls_ygdh=f_tel(ls_zrr)
				f_sms(ls_ygdh,ls_sms,ls_ygxm,"1")
			end if
		case 2
			if yf = yue and rq = dsrq then
				ls_ygxm = getname(ls_zrr)
				ls_sms="您好"+ ls_ygxm + "," + ls_wlmc +"需要进行维护!" +string(today(),'yyyy-mm-dd')
				ls_ygdh=f_tel(ls_zrr)
				f_sms(ls_ygdh,ls_sms,ls_ygxm,"1")
			end if
	end choose
next
		
f_logger(this.text + ' 已执行')
	
end event

type dw_zrr from uo_datawindow within wzr_automsg
integer x = 768
integer y = 148
integer taborder = 20
boolean bringtotop = true
string title = "公司"
string dataobject = "dwzr_zbfjyg"
end type

type dw_zrr1 from uo_datawindow within wzr_automsg
integer x = 1065
integer y = 148
integer taborder = 20
boolean bringtotop = true
string title = "部门"
string dataobject = "dwzr_zbfjyb"
end type

type cb_kpiauto from uo_commandbutton within wzr_automsg
integer x = 791
integer y = 48
integer width = 439
integer height = 72
integer taborder = 20
boolean bringtotop = true
integer weight = 700
string text = "绩效指标自动化"
end type

event clicked;call super::clicked;string year,month
year = string(year(today()))
month = string(month(today()))
//公司层面
dw_zrr.retrieve('20100827002',year)
dw_zbfjy.retrieve('20100827002',year)
//部门层面
dw_zrr1.retrieve('20100827002',year)
dw_bzbfjy.retrieve('20100827002',year)

//公司层面
long i,count = 0,day,mon,ll_find,fm,fz
dec{2} ldc_sjzz
dw_szpfall.retrieve(year,string(long(month) - 1))
fm = dw_szpfall.rowcount()
dw_szpfall.setfilter("(month( kp_time ) = (month(today()) - 1)) or (month( kp_time ) = month(today()) and day( kp_time  ) < 5)")
dw_szpfall.filter()
fz = dw_szpfall.rowcount()
//for i = 1 to dw_szpfall.rowcount()
//	if isnull(dw_szpfall.object.sz_tdm_s_time[i]) then
//		mon = month(date(dw_szpfall.object.sz_tdm_s_sjrq[i]))
//		day = day(date(dw_szpfall.object.sz_tdm_s_sjrq[i]))
//	else
//		mon = month(date(dw_szpfall.object.sz_tdm_s_time[i]))
//		day = day(date(dw_szpfall.object.sz_tdm_s_time[i]))
//	end if
//	if isnull(mon) then mon = 0
//	if isnull(day) then day = 0
//	if ((mon = long(month) and day > 5 ) or mon < long(month)) then
//	else
//		count++
//	end if
//next
count = dw_szpfall.rowcount()
if fz = 0 or fm = 0 then
	ldc_sjzz = 0 
else
	ldc_sjzz = fz/fm*100
end if

for i = 1 to dw_zrr.rowcount() 
	ll_find = dw_zbfjy.find("zb_month = '" + string(long(month)) + "' and zb_zrr = '" + dw_zrr.object.zb_zrr[i] + "'",1,dw_zbfjy.rowcount())
	dw_zbfjy.object.zb_sjzz[ll_find] = ldc_sjzz
next
if dw_zbfjy.update() = 1 then
	commit using sqlca;
else
	rollback using sqlca;
end if

//部门层面
long count1 = 0,ll_find1,j
string ls_zrr
dec{2} ldc_sjzz1
for i = 1 to dw_zrr1.rowcount()
	fz = 0
	fm = 0
	count1 = 0
	ls_zrr = dw_zrr1.object.zb_zrr[i]
	dw_szpf.retrieve(year,string(long(month) - 1),ls_zrr)
	dw_szpf.setfilter("1=1")
	dw_szpf.filter()
	fm = dw_szpf.rowcount()
	dw_szpf.setfilter("(month( kp_time ) = (month(today()) - 1)) or (month( kp_time ) = month(today()) and day( kp_time  ) < 5)")
	dw_szpf.filter()
	fz = dw_szpf.rowcount()
//	for j = 1 to dw_szpf.rowcount()
//		if isnull(dw_szpfall.object.sz_tdm_s_time[i]) then
//			mon = month(date(dw_szpfall.object.sz_tdm_s_sjrq[i]))
//			day = day(date(dw_szpfall.object.sz_tdm_s_sjrq[i]))
//		else
//			mon = month(date(dw_szpfall.object.sz_tdm_s_time[i]))
//			day = day(date(dw_szpfall.object.sz_tdm_s_time[i]))
//		end if
//		if isnull(mon) then mon = 0
//		if isnull(day) then day = 0
//		if ((mon = long(month) and day > 5 ) or mon < long(month)) then
//		else
//			count1++
//		end if
//	next
	if fz = 0 or fm = 0 then
		ldc_sjzz1 = 0
	else
		ldc_sjzz1 = fz/fm*100
	end if
	ll_find1 = dw_bzbfjy.find("zb_zrr = '" + ls_zrr + "' and zb_month = '" + string(long(month)) +"'",1,dw_bzbfjy.rowcount())
	dw_bzbfjy.object.zb_sjzz[ll_find1] = ldc_sjzz1
next

if dw_bzbfjy.update() = 1 then
	commit using sqlca;
else
	rollback using sqlca;
end if
	
f_logger(this.text + ' 已执行')
	
end event

type dw_szpf from uo_datawindow within wzr_automsg
integer x = 859
integer y = 576
integer width = 736
integer height = 492
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwn_rl_szpf"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type dw_szpfall from uo_datawindow within wzr_automsg
integer x = 375
integer y = 268
integer width = 869
integer height = 696
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_rl_szpf_all"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type dw_zbfjy from uo_datawindow within wzr_automsg
integer x = 1015
integer y = 364
integer width = 805
integer height = 592
integer taborder = 20
boolean bringtotop = true
string title = "公司"
string dataobject = "dwn_zbfjyg"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_insert from uo_commandbutton within wzr_automsg
integer x = 1271
integer y = 48
integer width = 494
integer height = 72
integer taborder = 20
boolean bringtotop = true
integer weight = 700
string text = "所有员工开通模块"
end type

event clicked;call super::clicked;open(wzr_autoadd)
end event

type dw_teacherkmadd from uo_datawindow within wzr_automsg
integer x = 1833
integer y = 180
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_teacherkmadd"
end type

type cb_teacheroec from uo_commandbutton within wzr_automsg
integer x = 1897
integer y = 40
integer width = 549
integer taborder = 20
boolean bringtotop = true
string text = "导师下达团队合作单"
end type

event clicked;call super::clicked;long i,send_times,fbts,ll_zt
string ls_ds,ls_xs
datetime ldt_rrsj
string ls_max,ls_now,ls_bm,ls_zrr,ls_gl,ls_lx,ls_wtbh,ls_fsr,ls_clbz,ls_kmrr,ls_jyjjfa
string ls_bz,ls_sfhp,ls_lz
date ldt_kssj,ldt_jssj
dw_teacherkmadd.retrieve()
for i = 1 to dw_teacherkmadd.rowcount()
	ls_ds = dw_teacherkmadd.object.teacher[i]
	ls_xs = dw_teacherkmadd.object.student[i]
	ldt_rrsj = dw_teacherkmadd.object.rrsj[i]
	send_times = dw_teacherkmadd.object.send_times[i]
	fbts = daysafter(date(ldt_rrsj),today())
	select zt into :ll_zt from user_name where job_num = :ls_xs;
	if ll_zt = 0 then continue
	if send_times < 5 then		
		choose case fbts
			case 7
				ls_kmrr = "请导师为新员工布置第一个月的工作内容，使新员工清晰工作目标，按要求完成工作。团队合作单的完成情况，将作为新员工试用期考核的依据之一。"
			case 30
				ls_kmrr = "请导师为新员工布置第二个月的工作内容，使新员工清晰工作目标，按要求完成工作。团队合作单的完成情况，将作为新员工试用期考核的依据之一。"
			case 60
				ls_kmrr = "请导师为新员工布置第三个月的工作内容，使新员工清晰工作目标，按要求完成工作。团队合作单的完成情况，将作为新员工试用期考核的依据之一。"
			case else
				continue
		end choose
		//给导师的第一个合作单
		select max(kmbh)
		into :ls_max
		from kmzzgl;
		if isnull(ls_max) then
			ls_now = string(f_getserverdate(),"yyyymmdd") + "ZW" +  "001"
		else
			if left(ls_max,8) = string(f_getserverdate(),"yyyymmdd") then
				ls_now = string(f_getserverdate(),"yyyymmdd") + "ZW" + string(integer(right(ls_max,3))+1,"000")
			else
				ls_now = string(f_getserverdate(),"yyyymmdd") + "ZW001"
			end if
		end if
		ldt_kssj = today()
		ldt_jssj = RelativeDate(ldt_kssj,3)
		ls_lz = '2'
		ls_zrr = ls_ds
		ls_gl = '2'
		ls_lx = '185'
		ls_wtbh = '85'
		ls_fsr = '000303'
		ls_clbz = '1'
		ls_bz = '0'
		ls_sfhp = '0'
		ls_jyjjfa = "1.请导师指导新员工团队合作单的填写；~r~n2.确保新员工清晰工作任务并指导完成；~r~n3.请完成团队合作单的填写并下达。"
		select bm into :ls_bm from kh_use where ygid = :ls_zrr;	
		INSERT INTO kmzzgl(kmbh,gl,kssj,jssj,lx,wtbh,zrr,fsr,bm,rrr,rrsj,clbz,kmrr,jyjjfa,bz,sfhp,lz) 
		VALUES (:ls_now,:ls_gl,:ldt_kssj,:ldt_jssj,:ls_lx,:ls_wtbh,:ls_zrr,:ls_fsr,:ls_bm,:ls_fsr,:ldt_kssj,:ls_clbz,:ls_kmrr,:ls_jyjjfa,:ls_bz,:ls_sfhp,:ls_lz);			
		fc_sqlcode0()
		
		//第二个合作单(空白)
		select max(kmbh)
		into :ls_max
		from kmzzgl;
		if isnull(ls_max) then
			ls_now = string(f_getserverdate(),"yyyymmdd") + "ZW" +  "001"
		else
			if left(ls_max,8) = string(f_getserverdate(),"yyyymmdd") then
				ls_now = string(f_getserverdate(),"yyyymmdd") + "ZW" + string(integer(right(ls_max,3))+1,"000")
			else
				ls_now = string(f_getserverdate(),"yyyymmdd") + "ZW001"
			end if
		end if
		ldt_kssj = today()
		ls_fsr = '000303'
		ls_clbz = '1'
		ls_bz = '0'
		ls_sfhp = '0'
		select bm into :ls_bm from kh_use where ygid = :ls_zrr;

		INSERT INTO kmzzgl(kmbh,rrr,rrsj,clbz,bz,sfhp,zrr,fsr,lz) 
		VALUES (:ls_now,:ls_fsr,:ldt_kssj,:ls_clbz,:ls_bz,:ls_sfhp,:ls_xs,:ls_ds,:ls_lz);			
		fc_sqlcode0()
		if sqlca.sqlcode = 0 then
			dw_teacherkmadd.object.send_times[i] =  dw_teacherkmadd.object.send_times[i] + 1
			f_save(dw_teacherkmadd)
		end if
		
		//下达oec
		string ls_ygid,ls_rrr,ls_shr,ls_wcsj
		datetime ldt_start,ldt_end,ldt_now
		long ll_ts,ll_n,ll_row,ll_rowcount,ll_insert,ll_x,ll_bh,ll_yy
		decimal ldc_fs
		ldt_start = datetime(date(today()),time("00:00:00"))
		ldt_end = datetime(date(RelativeDate(date(ldt_start),3)),time("00:00:00"))
	
		select rrr,yywcsj,shr,sr into :ls_rrr,:ls_wcsj:ls_shr,:ldc_fs from oectask where bh = 3174;
		ll_ts = DaysAfter(date(ldt_start),date(ldt_end))
	//	ll_ts = ll_ts + 1
		for ll_n = 1 to ll_ts
			if ll_n = 1 then
				ldt_now = ldt_start
			else
				ldt_now =  datetime(RelativeDate(date(string(ldt_start,"yyyy-mm-dd")),  ll_n - 1 ),time("00:00:00"))
			end if
		
			long daynum
			daynum = daynumber(date(ldt_now))
			if daynum = 1 or daynum = 7 then
				ldt_now = datetime(RelativeDate(date(string(ldt_start,"yyyy-mm-dd")),  ll_n + 1 ),time("00:00:00"))
			end if
			ls_ygid = ls_ds
			ll_bh = 3174
			ll_yy = dw_oecclear.retrieve(ldt_now,ls_ygid,ll_bh)
			if ll_yy < 1 then
				ll_insert = dw_oecclear.insertrow(0)
				dw_oecclear.object.rq[ll_insert] = ldt_now
				dw_oecclear.object.bh[ll_insert] = ll_bh
				dw_oecclear.object.xh[ll_insert] = ll_insert
				dw_oecclear.object.wcyf[ll_insert] = "0"
				dw_oecclear.object.zxr[ll_insert] = ls_ygid
				dw_oecclear.object.fqr[ll_insert] = ls_rrr
				dw_oecclear.object.yywcsj[ll_insert] = ls_wcsj
				dw_oecclear.object.fqsj[ll_insert] = f_getserverdate()
				//默认系统审核
				dw_oecclear.object.shr[ll_insert] = ls_shr
				dw_oecclear.object.wbz[ll_insert] = "0"
				dw_oecclear.object.sbz[ll_insert] = "0"
				dw_oecclear.object.qxbz[ll_insert] = "0"
				dw_oecclear.object.fs[ll_insert] = ldc_fs
				if dw_oecclear.update() = 1 then
					commit using sqlca;
				else
					rollback using sqlca;
				end if
			end if
		next
		
	end if
next
f_logger(this.text + ' 已执行')
end event

type dw_oecclear from uo_datawindow within wzr_automsg
integer x = 1842
integer y = 360
integer taborder = 20
boolean bringtotop = true
string dataobject = "dw_oecclear"
end type

type cb_gylfj from uo_commandbutton within wzr_automsg
integer x = 2565
integer width = 549
integer taborder = 20
boolean bringtotop = true
boolean enabled = false
string text = "供应链支付凭证导入"
end type

event clicked;call super::clicked;datastore dst
dst = create datastore
dst.dataobject = 'dwzr_gyl_pay_info'
dst.settransobject(sqlca)
dst.retrieve()
long i,maxbh
string ls_khdh,ls_twsm,ls_scwjlj,ls_scwjbh,ls_scr,khdh,ls_flag,ls_ygid
datetime ldt_szsj
for i = 1 to dst.rowcount()
	if isnull(dst.object.pay_img[i]) or dst.object.pay_img[i] = "" then
		continue
	else
		ls_khdh = 'gyl' + string(dst.object.order_sn[i])
		select max(twbh) into :maxbh from twzl where khdh = :ls_khdh;
		if isnull(maxbh) then
			maxbh = 1
		else
			maxbh = maxbh + 1
		end if
		khdh = dst.object.pay_img[i]
		select twsm,scwjbh,scwjlj,ygid,szsj,flag 
		into :ls_twsm,:ls_scwjbh,:ls_scwjlj,:ls_ygid,:ldt_szsj,:ls_flag
		from twzl
		where scwjbh = :khdh;
		if sqlca.sqlcode = 0 then
			INSERT INTO twzl(khdh,twbh,twsm,scwjbh,scwjlj,flag,ygid,szsj)
			VALUES (:ls_khdh,:maxbh,:ls_twsm,:ls_scwjbh,:ls_scwjlj,:ls_flag,:ls_ygid,:ldt_szsj);
			fc_sqlcode0()
		end if
	end if
next
end event

type dw_dzjxmx from uo_datawindow within wzr_automsg
boolean visible = false
integer y = 1604
integer width = 1550
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwr_gyl_dzjxmx"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type dw_khdh from uo_datawindow within wzr_automsg
boolean visible = false
integer x = 69
integer y = 1580
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_gyl_xqzy"
end type

type cb_dzmx from uo_commandbutton within wzr_automsg
integer x = 2551
integer y = 100
integer width = 658
integer taborder = 20
boolean bringtotop = true
string text = "供应链垫资利息每日更新"
end type

event clicked;call super::clicked;long i,j,ll_find,ll_jkts
string ls_rzbh,ls_khbh,ls_khdh
dw_rzbh.retrieve()
for i = 1 to dw_rzbh.rowcount()
	ls_rzbh = dw_rzbh.object.rzbh[i]
	ls_khbh = dw_rzbh.object.khbh[i]
	if isnull(dw_rzbh.object.jkzq[i]) then
		ll_jkts = 0
	else
		ll_jkts = dw_rzbh.object.jkzq[i]
	end if
	if dw_khdh.retrieve(ls_khbh,ls_rzbh) < 1 then continue
	for j = 1 to dw_khdh.rowcount()
		ls_khdh = dw_khdh.object.khdh[j]
		f_setlx(ls_khdh,ll_jkts)
	next
next
f_logger(this.text + ' 已执行')
end event

type dw_rzbh from uo_datawindow within wzr_automsg
boolean visible = false
integer x = 50
integer y = 1812
integer height = 184
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_gyl_rzdw"
end type

type cb_msdclvo from uo_commandbutton within wzr_automsg
integer x = 4805
integer y = 16
integer width = 439
integer taborder = 20
boolean bringtotop = true
boolean enabled = false
string text = "面试评分达成率"
end type

event clicked;call super::clicked;date ldt_today
datetime ldt_start,ldt_end
long month,day,year,startmonth,startyear,endyear,endmonth
long ll_jhmscnt,ll_sjmscnt,ll_find
dec{2} ldc_mspfdclv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_interviewfm_auto'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)



datastore dst1
dst1 = create datastore
dst1.dataobject = 'dwzr_interviewfz_auto'
dst1.settransobject(sqlca)
dst1.retrieve(ldt_start,ldt_end)

datastore dst2
dst2 = create datastore
dst2.dataobject = 'dwzr_ypfs_auto'
dst2.settransobject(sqlca)
dst2.retrieve(ldt_start,ldt_end)

datastore dst3
dst3 = create datastore
dst3.dataobject = 'dwzr_interviewfzgs_auto'
dst3.settransobject(sqlca)
dst3.retrieve(ldt_start,ldt_end)

datastore csry
csry = create datastore
csry.dataobject = 'dwzr_rl_csry'
csry.settransobject(sqlca)
csry.retrieve()

datastore fsry
fsry = create datastore
fsry.dataobject = 'dwzr_rl_fsry'
fsry.settransobject(sqlca)
fsry.retrieve()
//公司层面
long i
dw_gszrr.retrieve('20220824001',string(year))
dw_zbfjy.retrieve('20220824001',string(year))
for i = 1 to dw_gszrr.rowcount()
	ll_jhmscnt = dst.rowcount()
	ll_sjmscnt = dst3.rowcount()
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "'and zb_zrr = '" + dw_gszrr.object.zb_zrr[i] + "'",1,dw_zbfjy.rowcount())
	if ll_sjmscnt = 0 or ll_jhmscnt = 0 then
		ldc_mspfdclv = 0
	else
		ldc_mspfdclv = ll_sjmscnt/ll_jhmscnt*100
	end if	
	dw_zbfjy.object.zb_sjzz[ll_find] = ldc_mspfdclv
next
f_save(dw_zbfjy)

long ll_int
dec{2} ldc_mbz
string ls_month,ls_name,ls_bbbh
dw_bb.retrieve('20220824001')
ls_month = string(month)
ll_int = dw_bb.insertrow(0)
select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20220824001' and zb_month = :ls_month;
select zb_name into :ls_name from zb_jxb where zb_bh = '20220824001';
select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
dw_bb.object.bbbh[ll_int] = ls_bbbh
dw_bb.object.job_num[ll_int] = '000254'
dw_bb.object.zb_xh[ll_int] = '20220824001'
dw_bb.object.mbz[ll_int] = ldc_mbz
dw_bb.object.sjz[ll_int] = ldc_mspfdclv
dw_bb.object.zbmc[ll_int] = ls_name
dw_bb.object.dqsj[ll_int] = datetime(today(),now())
dw_bb.object.qssj[ll_int] = ldt_start
dw_bb.object.jssj[ll_int] = ldt_end
dw_bb.object.bz[ll_int] = '总计需求' + string(ll_jhmscnt) +'人' + ',完成' + string(ll_sjmscnt) +'人'
f_save(dw_bb)

//个人层面
string ls_zrr,ls_khdh,ls_khdh1
long j,ll_gw,ll_count,k,m,ypid
dst.setfilter("1=1")
dst.filter()
dst1.setfilter("1=1")
dst1.filter()
dw_grzrr.retrieve('20220824001',string(year))
dw_zbfjygr.retrieve('20220824001',string(year))
for i = 1 to dw_grzrr.rowcount()
	ls_zrr = dw_grzrr.object.zb_zrr[i]
	//分母
	ll_count = 0
	ll_jhmscnt = 0 
	for j = 1 to dst.rowcount()
		ypid = long(dst.object.id[j])
		ll_gw = dst.object.ypgw[j]
		ls_khdh = "fsry"+string(ll_gw)
		ls_khdh1 = "cymsg"+string(ll_gw)
		dw_msry.retrieve(ls_khdh,ls_khdh1,ls_zrr)
		if dw_msry.rowcount() > 0 then ll_jhmscnt++
	next
	csry.setfilter("ypid = " + string(ypid) + "and ygid = '" + ls_zrr + "'")
	csry.filter()
	if csry.rowcount() > 0 then 
		ll_jhmscnt = ll_jhmscnt + csry.rowcount()
	end if
	fsry.setfilter("ypid = " + string(ypid) + "and fsry = '" + ls_zrr + "'")
	fsry.filter()
	if fsry.rowcount() > 0 then 
		ll_jhmscnt = ll_jhmscnt + fsry.rowcount()
	end if
	//分子
	dst1.setfilter("lrr = '"+ls_zrr+"'")
	dst1.filter()
	ll_sjmscnt = dst1.rowcount()
	dst2.setfilter("pw = '" + ls_zrr + "'")
	dst2.filter()
	for k = 1 to dst2.rowcount()
			if dst2.object.pw[k] <> dst2.object.rl_yprypf_lrr[k] then
			ll_sjmscnt ++
		end if
	next
	
	
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "'and zb_zrr = '" + ls_zrr + "'",1,dw_zbfjygr.rowcount())
	if ll_sjmscnt = 0 or ll_jhmscnt = 0 then
		ldc_mspfdclv = 0
	else
		ldc_mspfdclv = ll_sjmscnt/ll_jhmscnt*100
	end if	
	dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_mspfdclv	
next
f_save(dw_zbfjygr)
f_logger(this.text + ' 已执行')





end event

type cb_mspfjslvo from uo_commandbutton within wzr_automsg
integer x = 4841
integer y = 140
integer width = 439
integer taborder = 30
boolean bringtotop = true
boolean enabled = false
string text = "面试评分及时率"
end type

event clicked;call super::clicked;date ldt_today
datetime ldt_start,ldt_end
long month,day,year,startmonth,startyear,endyear,endmonth
long ll_jhmscnt,ll_sjmscnt,ll_find
dec{2} ldc_mspfdclv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_interviewfm_auto'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)

datastore dst1
dst1 = create datastore
dst1.dataobject = 'dwzr_interviewfz_auto'
dst1.settransobject(sqlca)
dst1.retrieve(ldt_start,ldt_end)

datastore dst2
dst2 = create datastore
dst2.dataobject = 'dwzr_zbfjyr_zrr'
dst2.settransobject(sqlca)
dst2.retrieve('20220824002',string(year))

datastore csry
csry = create datastore
csry.dataobject = 'dwzr_rl_csry'
csry.settransobject(sqlca)
csry.retrieve()

datastore fsry
fsry = create datastore
fsry.dataobject = 'dwzr_rl_fsry'
fsry.settransobject(sqlca)
fsry.retrieve()

long j
string ls_zrr,ls_zrrname
long i,ypid,ll_msjs
string ls_time
datetime ldt_mssj,ldt_cssj,ldt_fssj
dw_gszrr.retrieve('20220824002',string(year))
dw_zbfjy.retrieve('20220824002',string(year))
for j = 1 to dw_gszrr.rowcount()
	ls_zrr = dw_gszrr.object.zb_zrr[j]
	ll_jhmscnt = dst.rowcount()
	ll_msjs = 0
	for i = 1 to ll_jhmscnt
		setnull(ldt_mssj)
		setnull(ldt_cssj)
		setnull(ldt_fssj)
		ypid = long(dst.object.id[i])
		select top 1 interviewtime into :ldt_mssj from szr_rl_ypry_dhsx where id = :ypid;
		select top 1 lrsj into :ldt_cssj from rl_yprypf where ypid = :ypid ;
		select top 1 sj into :ldt_fssj from rl_ypfs where ygid = :ypid ;

			
		ls_time = string(time(ldt_mssj))
		if time(ldt_mssj) > 09:00:00 then
			ls_time = string(long(left(ls_time,2)) - 9,'00') + mid(ls_time,3,len(ls_time))
		else
			ls_time = string(long(left(ls_time,2)) + 15 ,'00') + mid(ls_time,3,len(ls_time))
		end if
		if (date(ldt_mssj) = date(ldt_cssj) and date(ldt_mssj) = date(ldt_fssj)) or (date(ldt_mssj) = date(ldt_cssj) and isnull(ldt_fssj)) then	
			ll_msjs++
		elseif (DaysAfter(date(ldt_mssj),date(ldt_cssj)) = 1 and DaysAfter(date(ldt_mssj),date(ldt_fssj)) = 1) then
			if time(ldt_cssj) <= time(ls_time) and time(ldt_fssj) <= time(ls_time) then
				ll_msjs++
			end if	
		end if
	next
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "'and zb_zrr = '" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_msjs = 0 or ll_jhmscnt = 0 then
		ldc_mspfdclv = 0
	else
		ldc_mspfdclv = ll_msjs/ll_jhmscnt*100
	end if
	dw_zbfjy.object.zb_sjzz[ll_find] = ldc_mspfdclv
next
f_save(dw_zbfjy)

long ll_int
dec{2} ldc_mbz
string ls_month,ls_name,ls_bbbh
dw_bb.retrieve('20220824002')
ls_month = string(month)
ll_int = dw_bb.insertrow(0)
select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20220824002' and zb_month = :ls_month;
select zb_name into :ls_name from zb_jxb where zb_bh = '20220824002';
select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
dw_bb.object.bbbh[ll_int] = ls_bbbh
dw_bb.object.job_num[ll_int] = '000254'
dw_bb.object.zb_xh[ll_int] = '20220824002'
dw_bb.object.mbz[ll_int] = ldc_mbz
dw_bb.object.sjz[ll_int] = ldc_mspfdclv
dw_bb.object.zbmc[ll_int] = ls_name
dw_bb.object.dqsj[ll_int] = datetime(today(),now())
dw_bb.object.qssj[ll_int] = ldt_start
dw_bb.object.jssj[ll_int] = ldt_end
dw_bb.object.bz[ll_int] = '总计需求' + string(ll_jhmscnt) +'人' + ',完成' + string(ll_msjs) +'人'
f_save(dw_bb)

//个人层面
long ll_count,ll_gw,k
string ls_khdh,ls_khdh1,ls_zrr1
dw_grzrr.retrieve('20220824002',string(year))
dw_zbfjygr.retrieve('20220824002',string(year))
dst.setfilter("1=1")
dst.filter()
for i = 1 to dst2.rowcount()
	ls_zrr1 = dst2.object.zb_zrr[i]
	ls_zrrname = dw_grzrr.describe("Evaluate('LookupDisplay(zb_zrr)',"+string(i)+")")
	dst1.setfilter("lrr = '" + ls_zrr1 + "'")
	dst1.filter()
	ll_jhmscnt = 0
	ll_msjs = 0 
	ll_count = dst1.rowcount()
	for j = 1 to dst1.rowcount()
		ypid = long(dst1.object.ypid[j])
		ll_gw = dst1.object.rl_ypry_ypgw[j]
		ls_khdh = "fsry"+string(ll_gw)
		ls_khdh1 = "cymsg"+string(ll_gw)
		dw_msry.retrieve(ls_khdh,ls_khdh1,ls_zrr1)
		if dw_msry.rowcount() > 0 then ll_jhmscnt++
		
		csry.setfilter("ygid = '" + string(ls_zrr1) + "' and ypid = " + string(ypid))
		csry.filter()
		if csry.rowcount() > 0 then ll_jhmscnt = ll_jhmscnt + csry.rowcount()
		fsry.setfilter("fsry = '" + string(ls_zrr1) + "' and ypid = " + string(ypid))
		fsry.filter()
		if fsry.rowcount() > 0 then ll_jhmscnt = ll_jhmscnt + fsry.rowcount()
		

		setnull(ldt_mssj)
		setnull(ldt_cssj)
		setnull(ldt_fssj)
		
		select interviewtime into :ldt_mssj from szr_rl_ypry_dhsx where id = :ypid;
		select lrsj into :ldt_cssj from rl_yprypf where ypid = :ypid and lrr = :ls_zrr1;
		select sj into :ldt_fssj from rl_ypfs where ygid = :ypid and pw = :ls_zrr1;
		ls_time = string(time(ldt_mssj))
		if time(ldt_mssj) > 09:00:00 then
			ls_time = string(long(left(ls_time,2)) - 9,'00') + mid(ls_time,3,len(ls_time))
		else
			ls_time = string(long(left(ls_time,2)) + 15 ,'00') + mid(ls_time,3,len(ls_time))
		end if

		if (date(ldt_mssj) = date(ldt_cssj)) then //and isnull(ldt_fssj)) then
			ll_msjs++
		elseif  (date(ldt_mssj) = date(ldt_cssj) and date(ldt_mssj) = date(ldt_fssj)) then
			ll_msjs++
		elseif (DaysAfter(date(ldt_mssj),date(ldt_cssj)) = 1 and DaysAfter(date(ldt_mssj),date(ldt_fssj)) = 1) then
			if time(ldt_cssj) <= time(ls_time) and time(ldt_fssj) <= time(ls_time) then
				ll_msjs++
			end if	
		end if
	next
	
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "'and zb_zrr = '" + ls_zrr1 + "'",1,dw_zbfjygr.rowcount())
	
	if ll_msjs = 0 or ll_jhmscnt = 0 then
		ldc_mspfdclv = 0
	else
		ldc_mspfdclv = ll_msjs/ll_jhmscnt*100
	end if
	dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_mspfdclv
next
f_save(dw_zbfjygr)
f_logger(this.text + ' 已执行')
end event

type dw_gszrr from uo_datawindow within wzr_automsg
integer x = 23
integer y = 1220
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_zbfjyg_zrr"
end type

type dw_grzrr from uo_datawindow within wzr_automsg
integer x = 119
integer y = 1592
integer width = 709
integer height = 432
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_zbfjyr_zrr"
end type

type dw_zbfjygr from uo_datawindow within wzr_automsg
string tag = "个人"
integer x = 334
integer y = 624
integer width = 955
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwn_zbfjyr"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type dw_msry from uo_datawindow within wzr_automsg
integer x = 933
integer y = 1564
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_msry_auto"
end type

type cb_calsszq from uo_commandbutton within wzr_automsg
integer x = 2711
integer y = 376
integer width = 384
integer taborder = 20
boolean bringtotop = true
string text = "任职基数周期"
end type

event clicked;call super::clicked;long i,sfxh
datetime ldt_today,ldt_sfxh
dw_classzq.retrieve()
ldt_today = datetime(today(),now())
for i = 1 to dw_classzq.rowcount()
	sfxh = dw_classzq.object.class_name_sfxh[i]
	ldt_sfxh = dw_classzq.object.yxjssj[i]
	if ldt_today > ldt_sfxh and sfxh > 0 then
		f_auto(i)
	end if
	if ldt_today >= dw_classzq.object.qssj[i] and ldt_today <= dw_classzq.object.jssj[i] then
		dw_classzq.object.xdbz[i] = 1
	else
		dw_classzq.object.xdbz[i] = 0
	end if
next

f_save(dw_classzq)
f_logger(this.text + ' 已执行')
end event

type cb_xcxq from uo_commandbutton within wzr_automsg
integer x = 4256
integer y = 348
integer width = 713
integer taborder = 20
boolean bringtotop = true
integer weight = 700
string text = "薪酬需求进入当日工作绩效"
end type

event clicked;call super::clicked;datastore dst
dst = create datastore
dst.dataobject = 'dwzr_xcxq_auto'
dst.settransobject(sqlca)
dst.retrieve()
long ll_f,ts,i
string zrr
date ldt_today,ldt_start
datetime ldt_t
ldt_today = today()
ldt_t = datetime(RelativeDate(ldt_today,1),time('00:00:00'))//插入的日期
for i = 1 to dst.rowcount()
	ll_f = dst.object.rl_xcxq_position_relationship[i]
	ldt_start = date(dst.object.rl_xcxq_jobinfo_start_time[i])
	zrr = dst.object.rl_xcxq_fqr[i]
	if ll_f = 0 then
		ts = 25
	else
		ts = 20
	end if
	if DaysAfter(ldt_start,ldt_today) < ts then
		long ll_xh
		string ls_bh,ls_nr
		ls_nr =" 薪酬需求处理流程待处理（需求单号为" + dst.object.rl_xcxq_jobinfo_xqbh[i] + "岗位为" + dst.describe("Evaluate('LookupDisplay(rl_xcxq_jobinfo_jobid)',"+string(i)+")") + "）"
		select max(xh) into :ll_xh from jxjjgl where rq = :ldt_t and ygid = :zrr;
		if isnull(ll_xh) then
			ll_xh = 1 
		else
			ll_xh = ll_xh + 1
		end if
		ls_bh = string(ldt_t,"yyyymmdd") + zrr + string(ll_xh)
		INSERT INTO jxjjgl(qsj,zsj,jrsx,rq,ygid,xh,wc,tdrq,bh,bhbj)
		VALUES (:ldt_t,:ldt_t,:ls_nr,:ldt_t,:zrr,:ll_xh,"0",:ldt_t,:ls_bh,"0");
		fc_sqlcode0()
	end if
next
end event

type cb_b2bdclv from uo_commandbutton within wzr_automsg
integer x = 3538
integer y = 376
integer width = 521
integer taborder = 20
boolean bringtotop = true
string text = "b2b招聘计划达成率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month //绩效月
long i,j,year,xqrs,wcrs//需求人数，完成人数
dec{2} ldc_jhdclv
dw_b2bzp.retrieve()
f_getkpi(ldt_start,ldt_end,month)
dw_b2bzp.setfilter("string(xqsjks,'yyyy-mm-dd') >= '" + string(ldt_start,'yyyy-mm-dd') + "' and string(xqsjks,'yyyy-mm-dd') <= '" + string(ldt_end,'yyyy-mm-dd') + "' and bm = '008'")
dw_b2bzp.filter()
xqrs = 0
select sum(xqrs) into :xqrs from rl_ryxqb where rl_ryxqb.fqsjks >= '2021-10-21' and rl_ryxqb.rl_lx <> '1' and bm = '008' and rl_ryxqb.xqsjks <= :ldt_end and rl_ryxqb.xqsjks >= :ldt_start;
wcrs = 0
if dw_b2bzp.rowcount() > 0 then
	wcrs = long(dw_b2bzp.object.compute_2[1])
end if

if dw_b2bzp.rowcount() = 0 then
	ldc_jhdclv = 0
elseif xqrs = 0 or wcrs = 0 then
	ldc_jhdclv = 0
else
	ldc_jhdclv = wcrs/xqrs * 100
end if


year = year(date(ldt_end))
dw_gszrr.retrieve('20220915002',string(year))
dw_zbfjy.retrieve('20220915002',string(year))
dw_bb.retrieve('20220915002')
for j = 1 to dw_gszrr.rowcount()
	long ll_find
	string ls_zrr
	ls_zrr = dw_gszrr.object.zb_zrr[j]
	ll_find = dw_zbfjy.find("zb_zrr = '" + ls_zrr + "' and zb_month = '" + string(month) + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_jhdclv
	end if
	long ll_int
	dec{2} ldc_mbz
	string ls_month,ls_name,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20220915002' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20220915002';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20220915002'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_jhdclv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(xqrs) +'人' + ',完成' + string(wcrs) +'人'
	f_save(dw_bb)
next
f_save(dw_zbfjy)
f_logger(this.text + ' 已执行')
end event

type dw_b2bzp from uo_datawindow within wzr_automsg
integer x = 1536
integer y = 1236
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_ryxq_zpbbb2b"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type dw_b2bhglv from uo_datawindow within wzr_automsg
integer x = 1550
integer y = 1768
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_b2bhglv_auto"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_b2bhglv from uo_commandbutton within wzr_automsg
integer x = 3543
integer y = 484
integer width = 521
integer taborder = 20
boolean bringtotop = true
string text = "b2b人才招聘合格率"
end type

event clicked;call super::clicked;long month,day,year,year_start,year_end,month_start,month_end
long ll_fm,ll_fz
datetime ldt_start,ldt_end
dec{2} ldc_lv
dw_b2bhglv.retrieve()
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))

dw_b2bhglv.setfilter("string(kh_use_zzsj,'yyyy-mm-dd') >= '" + string(ldt_start,'yyyy-mm-dd') + "' and string(kh_use_zzsj,'yyyy-mm-dd') <= '" + string(ldt_end,'yyyy-mm-dd') + "'")
dw_b2bhglv.filter()
ll_fm = dw_b2bhglv.rowcount()

dw_b2bhglv.setfilter("string(kh_use_zzsj,'yyyy-mm-dd') >= '" + string(ldt_start,'yyyy-mm-dd') + "' and string(kh_use_zzsj,'yyyy-mm-dd') <= '" + string(ldt_end,'yyyy-mm-dd') + "'and kh_use_zzsj >= kh_use_sjzz and sjzz = 1 ")
dw_b2bhglv.filter()
ll_fz = dw_b2bhglv.rowcount()

if ll_fz = 0 or ll_fm = 0 then
	ldc_lv = 0
else
	ldc_lv = ll_fz/ll_fm * 100
end if
dw_gszrr.retrieve('20220915001',string(year))
dw_zbfjy.retrieve('20220915001',string(year))
dw_bb.retrieve('20220915001')
long i,j,ll_find
string zrr
for i = 1 to dw_gszrr.rowcount()
	zrr = dw_gszrr.object.zb_zrr[i]
	if month_start = 12 then
		dw_zbfjy.retrieve('20220915001',string(year - 1))
		if dw_zbfjy.rowcount() < 1 then 
			continue
		else
			ll_find = dw_zbfjy.find("zb_zrr = '" + zrr + "' and zb_month ='" + string(month_start) + "'",1,dw_zbfjy.rowcount())
			if ll_find > 0 then
				dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
			end if
		end if
	else
		for j = month_start + 1 to month_end
			ll_find = dw_zbfjy.find("zb_zrr = '" + zrr + "' and zb_month ='" + string(j) + "'",1,dw_zbfjy.rowcount())
			if ll_find > 0 then
				dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
			end if
		next
	end if
	
	long ll_int
	dec{2} ldc_mbz
	string ls_month,ls_name,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20220915001' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20220915001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = zrr
	dw_bb.object.zb_xh[ll_int] = '20220915001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_fm) +'人' + ',完成' + string(ll_fz) +'人'
	f_save(dw_bb)
next

f_save(dw_zbfjy)	
f_logger(this.text + ' 已执行')		
	
	

	
end event

type cb_zphglv from uo_commandbutton within wzr_automsg
integer x = 3543
integer y = 612
integer width = 521
integer taborder = 30
boolean bringtotop = true
string text = "招聘合格率"
end type

event clicked;call super::clicked;long month,day,year,year_start,year_end,month_start,month_end
long ll_fm,ll_fz,ll_m
datetime ldt_start,ldt_end
string ls_start,ls_end,ls_today
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_all.retrieve()
ls_today = string(today(),'yyyy-mm-dd')


//对月份进行处理
if ls_today >= string(year - 1) + '-12-21' and ls_today <= string(year) + '-03-20' then //算3 第一季度
	ls_start = string(year - 1) + '-12-21'
	ls_end = string(year) + '-03-20'
	ll_m = 3
elseif ls_today >= string(year) + '-03-21' and ls_today <= string(year) + '-06-20' then
	ls_start = string(year) + '-03-21'
	ls_end = string(year) + '-06-20'
	ll_m = 6
elseif ls_today >= string(year) + '-06-21' and ls_today <= string(year) + '-09-20' then
	ls_start = string(year) + '-06-21'
	ls_end = string(year) + '-09-20'
	ll_m = 9
elseif ls_today >= string(year) + '-09-21' and ls_today <= string(year) + '-12-20' then
	ls_start = string(year) + '-09-21'
	ls_end = string(year) + '-12-20'
	ll_m = 12
end if


dw_all.setfilter("string(kh_use_zzsj,'yyyy-mm-dd') >= '" + ls_start + "' and string(kh_use_zzsj,'yyyy-mm-dd') <= '" + ls_end + "'")
dw_all.filter()
ll_fm = dw_all.rowcount()

dw_all.setfilter("string(kh_use_zzsj,'yyyy-mm-dd') >= '" + ls_start + "' and string(kh_use_zzsj,'yyyy-mm-dd') <= '" + ls_end + "'and kh_use_zzsj >= kh_use_sjzz and sjzz = 1")
dw_all.filter()
ll_fz = dw_all.rowcount()

if ll_fz = 0 or ll_fm = 0 then
	ldc_lv = 0
else
	ldc_lv = ll_fz/ll_fm * 100
end if
dw_gszrr.retrieve('20100827001',string(year))
dw_zbfjy.retrieve('20100827001',string(year))
dw_bb.retrieve('20100827001')
long i,j,ll_find
string zrr


for i = 1 to dw_gszrr.rowcount()
	zrr = dw_gszrr.object.zb_zrr[i]
	if month = 12 and day(today()) > 21 then
		dw_zbfjy.retrieve('20100827001',string(year + 1))
		if dw_zbfjy.rowcount() < 1 then 
			continue
		else
			ll_find = dw_zbfjy.find("zb_zrr = '" + zrr + "' and zb_month ='" + string(ll_m) + "'",1,dw_zbfjy.rowcount())
			if ll_find > 0 then
				dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
			end if
		end if
	else
		ll_find = dw_zbfjy.find("zb_zrr = '" + zrr + "' and zb_month ='" + string(ll_m) + "'",1,dw_zbfjy.rowcount())
		if ll_find > 0 then
			dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
		end if
	end if
	
	long ll_int
	dec{2} ldc_mbz
	string ls_month,ls_name,ls_bbbh,ls_year
	ls_year = string(year)
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20100827001' and zb_year = :ls_year and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20100827001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = zrr
	dw_bb.object.zb_xh[ll_int] = '20100827001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = datetime(date(ls_start),time('00:00:00'))
	dw_bb.object.jssj[ll_int] = datetime(date(ls_end),time('00:00:00'))
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_fm) +'人' + ',完成' + string(ll_fz) +'人'
	f_save(dw_bb)
next
f_save(dw_zbfjy)	
f_logger(this.text + ' 已执行')		
	
	

	
end event

type dw_all from uo_datawindow within wzr_automsg
integer x = 1961
integer y = 1252
integer taborder = 30
boolean bringtotop = true
string dataobject = "dwzr_allzphglv_auto"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type dw_bb from uo_datawindow within wzr_automsg
integer x = 119
integer y = 1752
integer width = 1746
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwn_bbzx_zb"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type dw_zpbb from uo_datawindow within wzr_automsg
integer x = 1797
integer y = 1740
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_ryxq_zpbb"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_szmt from uo_commandbutton within wzr_automsg
string tag = "20220710001"
integer x = 3547
integer y = 748
integer width = 512
integer height = 84
integer taborder = 20
boolean bringtotop = true
string text = "述职面谈率"
end type

event clicked;call super::clicked;long year,month,i,j,ll_c
datetime ldt_start,ldt_end
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_zrr1.retrieve('20220710001',string(year))//部门分解
dw_bzbfjy.retrieve('20220710001',string(year))
dw_bb.retrieve('20220710001')
dw_szmt.retrieve(string(year))

for i = 1 to dw_zrr1.rowcount()
	string ls_zrr
	long ll_find,row
	dec{2} ldc_value
	ls_zrr = dw_zrr1.object.zb_zrr[i]
	dw_szmt.setfilter("department_fzr = '" + ls_zrr + "'")
	dw_szmt.filter()
	row = dw_szmt.rowcount()
	if row > 0 then
		ll_c = dw_szmt.getitemnumber(1,"m_"+string(month))
	else 
		ll_c = 0
	end if
	ll_find = dw_bzbfjy.find("zb_zrr = '" + ls_zrr + "' and zb_month = '" + string(month) + "'",1,dw_bzbfjy.rowcount())
	if ll_find > 0 then
		if ll_c > 0 then
			ldc_value = 50
		else
			ldc_value = 0
		end if
	end if
	dw_bzbfjy.object.zb_sjzz[ll_find] = ldc_value
	
	long ll_int
	dec{2} ldc_mbz
	string ls_month,ls_name,ls_bbbh,ls_year
	ls_year = string(year)
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20220710001' and zb_year = :ls_year and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20220710001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20220710001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_value
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '本月总计面谈' + string(ll_c) +'人' 
	f_save(dw_bb)

next
f_save(dw_bzbfjy)
f_logger(this.text + ' 已执行')
end event

type dw_szmt from uo_datawindow within wzr_automsg
integer x = 1865
integer y = 512
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_zblooksz_mtjcbauto"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_mtjl from commandbutton within wzr_automsg
integer x = 3968
integer y = 20
integer width = 713
integer height = 84
integer taborder = 30
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "招聘面谈记录表每周一生成"
end type

event clicked;if daynumber(today()) <> 2 then return
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_mtjl_zpall1'
dst.settransobject(sqlca)
dst.retrieve()
long i,ins
datetime ldt_start,ldt_end
ldt_start = datetime(today(),time('00:00:00'))
ldt_end = datetime(RelativeDate(date(ldt_start),6),time('23:59:59'))
for i = 1 to dst.rowcount()
	ins = dw_mtjl.insertrow(0)
	dw_mtjl.object.xqbh[ins] = dst.object.khdh[i]
	dw_mtjl.object.job[ins] = long(dst.object.job[i])
	dw_mtjl.object.xqsjks[ins] = dst.object.xqsjks[i]
	dw_mtjl.object.xqrs[ins] = dst.object.xqrs[i]
	dw_mtjl.object.fqr[ins] = dst.object.fqr[i]
	dw_mtjl.object.xq_details[ins] = dst.object.beizhu[i]
	dw_mtjl.object.zp_fzr[ins] = dst.object.zp_fzr[i]
	dw_mtjl.object.start_time[ins] = ldt_start
	dw_mtjl.object.end_time[ins] = ldt_end
	dw_mtjl.object.bz[ins] = dst.object.bz[i]
next
f_save(dw_mtjl)
//f_logger(this.text + ' 已执行')
end event

type dw_mtjl from uo_datawindow within wzr_automsg
boolean visible = false
integer x = 4731
integer y = 20
integer width = 965
integer height = 292
integer taborder = 40
boolean bringtotop = true
string dataobject = "dwzr_recruitment_interview"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_zpjhdclv from uo_commandbutton within wzr_automsg
string tag = "20101124001"
integer x = 3566
integer y = 868
integer width = 521
integer taborder = 30
boolean bringtotop = true
string text = "招聘计划达成率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month //绩效月
long i,j,year,xqrs,wcrs//需求人数，完成人数
dec{2} ldc_jhdclv
dw_ryxq_zpbb.retrieve()
f_getkpi(ldt_start,ldt_end,month)
dw_ryxq_zpbb.setfilter("string(xqsjks,'yyyy-mm-dd') >= '" + string(ldt_start,'yyyy-mm-dd') + "' and string(xqsjks,'yyyy-mm-dd') <= '" + string(ldt_end,'yyyy-mm-dd') + "'")
dw_ryxq_zpbb.filter()
xqrs = 0
select sum(xqrs) into :xqrs from rl_ryxqb where rl_ryxqb.fqsjks >= '2021-10-21' and rl_ryxqb.rl_lx <> '1' and rl_ryxqb.xqsjks <= :ldt_end and rl_ryxqb.xqsjks >= :ldt_start and bz <> '4';
wcrs = 0
if dw_ryxq_zpbb.rowcount() > 0 then
	wcrs = long(dw_ryxq_zpbb.object.compute_2[1])
end if

if dw_ryxq_zpbb.rowcount() = 0 then
	ldc_jhdclv = 0
elseif xqrs = 0 or wcrs = 0 then
	ldc_jhdclv = 0
else
	ldc_jhdclv = wcrs/xqrs * 100
end if

year = year(date(ldt_end))
dw_gszrr.retrieve('20101124001',string(year))
dw_zbfjy.retrieve('20101124001',string(year))
dw_bb.retrieve('20101124001')
for j = 1 to dw_gszrr.rowcount()
	long ll_find
	string ls_zrr
	ls_zrr = dw_gszrr.object.zb_zrr[j]
	ll_find = dw_zbfjy.find("zb_zrr = '" + ls_zrr + "' and zb_month = '" + string(month) + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_jhdclv
	end if
	long ll_int
	dec{2} ldc_mbz
	string ls_month,ls_name,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.find("date(dqsj) = date(today()) and zb_xh = '20101124001' and job_num = '" + ls_zrr + "'",1,dw_bb.rowcount() )
	if ll_int = 0 then
		ll_int = dw_bb.insertrow(0)
		select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20101124001' and zb_month = :ls_month and zb_year = :year;
		select zb_name into :ls_name from zb_jxb where zb_bh = '20101124001';
		select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
		ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
		dw_bb.object.bbbh[ll_int] = ls_bbbh
		dw_bb.object.mbz[ll_int] = ldc_mbz
		dw_bb.object.zbmc[ll_int] = ls_name
	end if

	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20101124001'
	dw_bb.object.sjz[ll_int] = ldc_jhdclv
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(xqrs) +'人' + ',完成' + string(wcrs) +'人'
	f_save(dw_bb)
next
f_save(dw_zbfjy)
f_logger(this.text + ' 已执行')
end event

type dw_ryxq_zpbb from uo_datawindow within wzr_automsg
integer x = 2062
integer y = 1304
integer taborder = 30
boolean bringtotop = true
string dataobject = "dwzr_ryxq_zpbb"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_gsbdbook from commandbutton within wzr_automsg
integer x = 2711
integer y = 492
integer width = 494
integer height = 84
integer taborder = 40
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "公司必读书籍下达"
end type

event clicked;datastore book
book = create datastore
book.dataobject = 'dwzr_sjda_bd'//必读书籍
book.settransobject(sqlca)
book.retrieve()
long i,j,ll_sjbh,if_success,ll_ts
string ls_sjmc,ls_sjfl,ls_wxlx,ls_ydjd,ls_pfff,ls_rzjs,ls_ydmb,ls_rwxdry,ls_ygid,ls_tel
string ls_xxfx
datastore user
user = create datastore
user.dataobject = 'dwzr_user_todayin'
user.settransobject(sqlca)
if user.retrieve() < 1 then return
for j = 1 to user.rowcount()
	if_success = 0
	for i = 1 to book.rowcount( )
		ll_sjbh = book.object.id[i]
		ls_sjmc = book.object.mc[i]
		ls_sjfl = book.object.fl[i]
		ls_wxlx = book.object.wxlx[i]
		ls_ydjd = book.object.ydjd[i]
		ls_pfff = book.object.ydpf[i]
		ls_rzjs = book.object.yq[i]
		ls_ydmb = book.object.ydmb[i]
		ls_xxfx = book.object.xxfx[i]
		ls_ygid = user.object.ygid[j]
		choose case ls_ydjd
			case '1'
				ll_ts = 0
			case '2'
				ll_ts = 30
			case '3'
				ll_ts = 60
			case '4'
				ll_ts = 150
			case '5'
				ll_ts = 365
			case '6'
				ll_ts = 730
		end choose
		datetime ldt_jhkssj,ldt_jhjssj
		ldt_jhkssj = datetime(RelativeDate(date(user.object.rzsj[j]),ll_ts),time('00:00:00'))
		ldt_jhjssj = datetime(RelativeDate(date(user.object.rzsj[j]),ll_ts+30),time('00:00:00'))
		datetime ldt_xdsj
		ldt_xdsj = user.object.rzsj[j]
		string ls_plan
		select max(plan_num) into :ls_plan from sjda_learnplanning;
		if isnull(ls_plan) then
			ls_plan = 'XXJH000001'
		else
			ls_plan = 'XXJH' + string(long(right(ls_plan,6)) + 1,'000000')
		end if
//		
//		update s_wdxxjh set plan_num = :ls_plan where ygid = :ls_ygid and rwxdry = '系统自动' and sjbh = :ll_sjbh;
//		fc_sqlcode0()
		insert into s_wdxxjh(jhkssj,jhjssj,sjbh,sjmc,sjfl,wxlx,ydjd,pfff,rzjs,ydmb,rwxdry,xxjf,ygid,plan_num) 
		values(:ldt_jhkssj,:ldt_jhjssj,:ll_sjbh,:ls_sjmc,:ls_sjfl,:ls_wxlx,:ls_ydjd,:ls_pfff,:ls_rzjs,:ls_ydmb,'系统自动','10',:ls_ygid,:ls_plan);
		fc_sqlcode0()		
		INSERT INTO sjda_learnplanning(sjdaid,plan_num,release_time,read_persons,start_time,end_time,xxfx,rzjs,ydpf)
		VALUES (:ll_sjbh,:ls_plan,:ldt_xdsj,:ls_ygid,:ldt_jhkssj,:ldt_jhjssj,:ls_xxfx,:ls_rzjs,:ls_pfff);
		if sqlca.sqlcode = 0 then
			commit using sqlca;
			if_success = 1
		else
			rollback using sqlca;
		end if
	next
	if if_success = 1 then
		ls_tel=f_tel(ls_ygid)
		f_sms(ls_tel,"您好！您有一条阅读任务，请到“培训管理”―“我的培训”-“我的培训与学习计划”-“我的学习计划”-“公司必读书籍”查看，请您尽快确认。",'000134','1')
	end if
next
f_logger(this.text + ' 已执行')
end event

type st_1 from statictext within wzr_automsg
integer x = 3547
integer y = 56
integer width = 402
integer height = 48
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
long textcolor = 33554432
long backcolor = 67108864
string text = "招聘："
boolean focusrectangle = false
end type

type st_2 from statictext within wzr_automsg
integer x = 2743
integer y = 288
integer width = 402
integer height = 48
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
long textcolor = 33554432
long backcolor = 67108864
string text = "培训："
boolean focusrectangle = false
end type

type cb_zpjhjslv from uo_commandbutton within wzr_automsg
string tag = "20200103001"
integer x = 3566
integer y = 1004
integer width = 521
integer taborder = 40
boolean bringtotop = true
string text = "招聘及时率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month //绩效月
long i,j,year,xqrs,wcrs//需求人数，完成人数
dec{2} ldc_jhdclv
dw_ryxq_zpbb.retrieve()
f_getkpi(ldt_start,ldt_end,month)
dw_ryxq_zpbb.setfilter("string(xqsjks,'yyyy-mm-dd') >= '" + string(ldt_start,'yyyy-mm-dd') + "' and string(xqsjks,'yyyy-mm-dd') <= '" + string(ldt_end,'yyyy-mm-dd') + "'")
dw_ryxq_zpbb.filter()
xqrs = 0
select sum(xqrs) into :xqrs from rl_ryxqb where rl_ryxqb.fqsjks >= '2021-10-21' and rl_ryxqb.rl_lx <> '1' and rl_ryxqb.xqsjks <= :ldt_end and rl_ryxqb.xqsjks >= :ldt_start and bz <> '4';
for i = 1 to dw_ryxq_zpbb.rowcount()
	if dw_ryxq_zpbb.object.zpss_dgsj[i] <= dw_ryxq_zpbb.object.xqsjks[i] then
		wcrs ++
	end if
next

if dw_ryxq_zpbb.rowcount() = 0 then
	ldc_jhdclv = 0
elseif xqrs = 0 or wcrs = 0 then
	ldc_jhdclv = 0
else
	ldc_jhdclv = wcrs/xqrs * 100
end if

year = year(date(ldt_end))
dw_gszrr.retrieve('20200103001',string(year))
dw_zbfjy.retrieve('20200103001',string(year))
dw_bb.retrieve('20200103001')
for j = 1 to dw_gszrr.rowcount()
	long ll_find
	string ls_zrr
	ls_zrr = dw_gszrr.object.zb_zrr[j]
	ll_find = dw_zbfjy.find("zb_zrr = '" + ls_zrr + "' and zb_month = '" + string(month) + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_jhdclv
	end if
	long ll_int
	dec{2} ldc_mbz
	string ls_month,ls_name,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20200103001' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20200103001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20200103001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_jhdclv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(xqrs) +'人' + ',完成' + string(wcrs) +'人'
	f_save(dw_bb)
next
f_save(dw_zbfjy)
f_logger(this.text + ' 已执行')
end event

type cb_oec from uo_commandbutton within wzr_automsg
integer x = 2990
integer y = 248
integer taborder = 20
boolean bringtotop = true
string text = "本人日清"
end type

event clicked;call super::clicked;dw_oec.retrieve('000393',datetime(today(),time('00:00:00')))
long i
for i = 1 to dw_oec.rowcount()
	dw_oec.object.oecclear_wcyf[i] = '1'
next
f_save(dw_oec)
end event

type dw_rzgjjxn from uo_datawindow within wzr_automsg
integer x = 2171
integer y = 1784
integer width = 393
integer height = 228
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_rzgj_autojxn"
end type

type cb_rzgjjxn from uo_commandbutton within wzr_automsg
integer x = 3575
integer y = 1116
integer width = 439
integer taborder = 20
boolean bringtotop = true
string text = "入职跟进绩效能"
end type

event clicked;call super::clicked;long i,ll_xh
datetime ldt_today
string ls_ygid,ls_jrsx,ls_bh
ldt_today = datetime(today(),time('00:00:00'))
dw_rzgjjxn.retrieve(ldt_today)
for i = 1 to dw_rzgjjxn.rowcount()
	ls_ygid = f_getygid(dw_rzgjjxn.object.yqwcr[i])
	ls_jrsx = '入职跟进：完成' + dw_rzgjjxn.describe("Evaluate('LookupDisplay(kh_use_gwbh)',"+string(i)+")") + '-' + dw_rzgjjxn.object.ygxm[i] + '对应入职跟进程序'
	select max(xh) into :ll_xh from jxjjgl where rq = :ldt_today and ygid = :ls_ygid;
	if isnull(ll_xh) then
		ll_xh = 1 
	else
		ll_xh = ll_xh + 1
	end if
	ls_bh = string(ldt_today,"yyyymmdd") + ls_ygid + string(ll_xh)
	INSERT INTO jxjjgl(qsj,zsj,jrsx,rq,ygid,xh,wc,tdrq,bh,bhbj)
	VALUES (:ldt_today,:ldt_today,:ls_jrsx,:ldt_today,:ls_ygid,:ll_xh,"0",:ldt_today,:ls_bh,"0");
	fc_sqlcode0()
next
f_logger(this.text + ' 已执行')
end event

type dw_zjjl from uo_datawindow within wzr_automsg
integer x = 1737
integer y = 1464
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_zjjl"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_zjjl from uo_commandbutton within wzr_automsg
integer x = 2839
integer y = 1176
integer width = 494
integer taborder = 20
boolean bringtotop = true
string text = "证件短信提醒办件"
end type

event clicked;call super::clicked;dw_zjjl.retrieve()
long i,ts
datetime ldt_dqsj,ldt_yjsj,ldt_today
ldt_today = f_getserverdate()
for i = 1 to dw_zjjl.rowcount()
	ldt_dqsj = dw_zjjl.object.yjxcsj[i]
	ldt_yjsj = dw_zjjl.object.zzsj[i]
	if dw_zjjl.object.processing[i] = '暂时不办理' or dw_zjjl.object.processing[i] = '已重新办理' then continue
	if ldt_today >= ldt_dqsj and ldt_today <= ldt_yjsj then
		string name,zjlx,bz,zrr,ls_tel,ls_msg
		name = dw_zjjl.describe("Evaluate('LookupDisplay(ygid)',"+string(i)+")")
		zjlx = dw_zjjl.describe("Evaluate('LookupDisplay(zjlx)',"+string(i)+")")
		bz = dw_zjjl.object.bz[i]
		zrr = dw_zjjl.object.zrr[i]
		if len(zrr) < 1 or isnull(zrr) then
			zrr = '000388'
		end if
		ls_msg = "您好！"+name + "的" + zjlx + "(" + bz +")状态即将到期，请您尽快重新办理！"
//		messagebox("",ls_msg)
		ls_tel=f_tel(zrr)
		f_sms(ls_tel,ls_msg,'000134','1')
	end if
next
end event

type st_3 from statictext within wzr_automsg
integer x = 2807
integer y = 1072
integer width = 402
integer height = 48
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
long textcolor = 33554432
long backcolor = 67108864
string text = "行政："
boolean focusrectangle = false
end type

type cb_rzgjwclv from uo_commandbutton within wzr_automsg
integer x = 3634
integer y = 1236
integer width = 549
integer height = 84
integer taborder = 20
boolean bringtotop = true
string text = "人员入职跟进完成率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month,year,i,j,ll_mole,ll_den,ll_find
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230205001',string(year))
dw_grzrr.retrieve('20230205001',string(year))
dw_zbfjy.retrieve('20230205001',string(year))
dw_zbfjygr.retrieve('20230205001',string(year))
dw_bb.retrieve('20230205001')
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_rzgj_autozb'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
//公司层面
for i = 1 to dw_gszrr.rowcount()
	string ls_zrr,ls_name
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	ll_den = dst.rowcount()
	ll_mole = 0
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
next
f_Save(dw_zbfjy)
//个人层面
for i = 1 to dw_grzrr.rowcount()
	ls_zrr = dw_grzrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	dst.setfilter( " sjwcr = '" + ls_zrr + "'")
	dst.filter()
	ll_den = dst.rowcount()
	ll_mole = 0
	dst.setfilter(" sjwcr = '" + ls_zrr + "'")
	dst.filter()
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230205001' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230205001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230205001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_den) +'条' + ',完成' + string(ll_mole) +'条'
	f_save(dw_bb)
next
f_Save(dw_zbfjygr)

f_logger(this.text + ' 已执行')
end event

type cb_rzgjjslv from uo_commandbutton within wzr_automsg
integer x = 3685
integer y = 1356
integer width = 549
integer taborder = 30
boolean bringtotop = true
string text = "人员入职跟进及时率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month,year,i,j,ll_mole,ll_den,ll_find
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230205002',string(year))
dw_grzrr.retrieve('20230205002',string(year))
dw_zbfjy.retrieve('20230205002',string(year))
dw_zbfjygr.retrieve('20230205002',string(year))
dw_bb.retrieve('20230205002')
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_rzgj_autozb'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
//公司层面
for i = 1 to dw_gszrr.rowcount()
	string ls_zrr,ls_name
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	ll_den = dst.rowcount()
	ll_mole = 0
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 and dst.object.sjsj[j] <= dst.object.yqsj[j] then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
next
f_Save(dw_zbfjy)
//个人层面
for i = 1 to dw_grzrr.rowcount()
	ls_zrr = dw_grzrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	dst.setfilter( " sjwcr = '" + ls_zrr + "'")
	dst.filter()
	//分母
	ll_den = dst.rowcount()
	ll_mole = 0
	dst.setfilter(" sjwcr = '" + ls_zrr + "'")
	dst.filter()
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 and dst.object.sjsj[j] <= dst.object.yqsj[j] then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230205002' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230205002';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230205002'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_den) +'条' + ',完成' + string(ll_mole) +'条'
	f_save(dw_bb)
next
f_Save(dw_zbfjygr)

f_logger(this.text + ' 已执行')
end event

type dw_classzq from uo_datawindow within wzr_automsg
integer x = 882
integer y = 1004
integer width = 1605
integer height = 804
integer taborder = 20
string dataobject = "dwzr_class_zq"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_interviewwclv from uo_commandbutton within wzr_automsg
integer x = 3698
integer y = 1464
integer width = 823
integer taborder = 40
boolean bringtotop = true
string text = "新员工面谈问题反馈处理完成率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month,year,i,j,ll_mole,ll_den,ll_find
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230205003',string(year))
dw_zbfjy.retrieve('20230205003',string(year))
dw_bb.retrieve('20230205003')
datastore fm
fm = create datastore
fm.dataobject = 'dwzr_rl_interview_impotsjl_auto'
fm.settransobject(sqlca)
fm.retrieve(ldt_start,ldt_end)

datastore fz
fz = create datastore
fz.dataobject = 'dwzr_rl_interview_impotsjl_auto1'
fz.settransobject(sqlca)
fz.retrieve(ldt_start,ldt_end)

ll_den = fm.rowcount()
ll_mole = fz.rowcount()
//公司层面
for i = 1 to dw_gszrr.rowcount()
	string ls_zrr,ls_name
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	
	if ll_mole = 0 then
		ldc_lv = 0
	else
		ldc_lv = ll_mole / ll_den * 100
	end if
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230205003' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230205003';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230205003'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_den) +'条' + ',完成' + string(ll_mole) +'条'
	f_save(dw_bb)
next
f_Save(dw_zbfjy)

f_logger(this.text + ' 已执行')
end event

type cb_czglhd from uo_commandbutton within wzr_automsg
integer x = 4229
integer y = 596
integer width = 823
integer taborder = 20
boolean bringtotop = true
string text = "参展管理活动自动导入工作内容"
end type

event clicked;call super::clicked;//陈芝琴
long i,j,ll_hdbh
string ls_hdflbh,ls_hdbh
datetime ldt_drsj
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_xmjcnr1_auto'
dst.settransobject(sqlca)
dw_hdflb.retrieve()
for i = 1 to dw_hdflb.rowcount()
	ls_hdflbh = dw_hdflb.object.hdflbh[i]
	ll_hdbh = dw_hdflb.object.xh[i]
	ls_hdbh = string(dw_hdflb.object.xh[i])
	ldt_drsj = dw_hdflb.object.compute_3[i]
	if DaysAfter(date(ldt_drsj),today()) = 0 then
		dw_xmjcnr.reset()
		dst.retrieve(ls_hdflbh)
		dst.rowscopy(1,dst.rowcount(),primary!,dw_xmjcnr,dst.rowcount() + 1,primary!)
		for j = 1 to dst.rowcount( )
			dw_xmjcnr.object.hdflbh[j] = ls_hdbh
		next
		f_save(dw_xmjcnr)
		update hdlb set szr_auto = 1 where xh = :ll_hdbh;
		fc_sqlcode0()
	end if
next

f_logger(this.text + ' 已执行')
end event

type dw_xmjcnr from uo_datawindow within wzr_automsg
integer x = 5253
integer y = 576
integer width = 590
integer height = 584
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_xmjcnr1_auto"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type st_4 from statictext within wzr_automsg
integer x = 4219
integer y = 512
integer width = 402
integer height = 48
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
long textcolor = 33554432
long backcolor = 67108864
string text = "业务："
boolean focusrectangle = false
end type

type dw_hdflb from uo_datawindow within wzr_automsg
integer x = 5742
integer y = 572
integer width = 425
integer height = 608
integer taborder = 20
boolean bringtotop = true
string dataobject = "dw_hdlbrryjx_auto"
end type

type cb_lzgjwclv from uo_commandbutton within wzr_automsg
integer x = 3707
integer y = 1576
integer width = 549
integer height = 84
integer taborder = 30
boolean bringtotop = true
string text = "人员离职跟进完成率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month,year,i,j,ll_mole,ll_den,ll_find
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230209002',string(year))
dw_grzrr.retrieve('20230209002',string(year))
dw_zbfjy.retrieve('20230209002',string(year))
dw_zbfjygr.retrieve('20230209002',string(year))
dw_bb.retrieve('20230209002')
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_rzgj_autozb_lz'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
//公司层面
for i = 1 to dw_gszrr.rowcount()
	string ls_zrr,ls_name
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	ll_den = dst.rowcount()
	ll_mole = 0
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
next
f_Save(dw_zbfjy)
//个人层面
for i = 1 to dw_grzrr.rowcount()
	ls_zrr = dw_grzrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	dst.setfilter( " sjwcr = '" + ls_zrr + "'")
	dst.filter()
	ll_den = dst.rowcount()
	ll_mole = 0
	dst.setfilter(" sjwcr = '" + ls_zrr + "'")
	dst.filter()
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230209002' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230209002';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230209002'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_den) +'条' + ',完成' + string(ll_mole) +'条'
	f_save(dw_bb)
next
f_Save(dw_zbfjygr)

f_logger(this.text + ' 已执行')
end event

type cb_lzgjjslv from uo_commandbutton within wzr_automsg
integer x = 3712
integer y = 1696
integer width = 549
integer taborder = 40
boolean bringtotop = true
string text = "人员离职跟进及时率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month,year,i,j,ll_mole,ll_den,ll_find
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230209003',string(year))
dw_grzrr.retrieve('20230209003',string(year))
dw_zbfjy.retrieve('20230209003',string(year))
dw_zbfjygr.retrieve('20230209003',string(year))
dw_bb.retrieve('20230209003')
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_rzgj_autozb_lz'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
//公司层面
for i = 1 to dw_gszrr.rowcount()
	string ls_zrr,ls_name
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	ll_den = dst.rowcount()
	ll_mole = 0
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 and dst.object.sjsj[j] <= dst.object.yqsj[j] then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
next
f_Save(dw_zbfjy)
//个人层面
for i = 1 to dw_grzrr.rowcount()
	ls_zrr = dw_grzrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	dst.setfilter( " sjwcr = '" + ls_zrr + "'")
	dst.filter()
	//分母
	ll_den = dst.rowcount()
	ll_mole = 0
	dst.setfilter(" sjwcr = '" + ls_zrr + "'")
	dst.filter()
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 and dst.object.sjsj[j] <= dst.object.yqsj[j] then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230209003' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230209003';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230209003'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_den) +'条' + ',完成' + string(ll_mole) +'条'
	f_save(dw_bb)
next
f_Save(dw_zbfjygr)

f_logger(this.text + ' 已执行')
end event

type cb_gwydjslv from uo_commandbutton within wzr_automsg
integer x = 3712
integer y = 1936
integer width = 549
integer taborder = 50
boolean bringtotop = true
string text = "岗位异动跟进及时率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month,year,i,j,ll_mole,ll_den,ll_find
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230212002',string(year))
dw_grzrr.retrieve('20230212002',string(year))
dw_zbfjy.retrieve('20230212002',string(year))
dw_zbfjygr.retrieve('20230212002',string(year))
dw_bb.retrieve('20230212002')
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_rzgj_autozb_changejob'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
//公司层面
for i = 1 to dw_gszrr.rowcount()
	string ls_zrr,ls_name
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	ll_den = dst.rowcount()
	ll_mole = 0
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 and dst.object.sjsj[j] <= dst.object.yqsj[j] then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
next
f_Save(dw_zbfjy)
//个人层面
for i = 1 to dw_grzrr.rowcount()
	ls_zrr = dw_grzrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	dst.setfilter( " sjwcr = '" + ls_zrr + "'")
	dst.filter()
	//分母
	ll_den = dst.rowcount()
	ll_mole = 0
	dst.setfilter(" sjwcr = '" + ls_zrr + "'")
	dst.filter()
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 and dst.object.sjsj[j] <= dst.object.yqsj[j] then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230212002' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230212002';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230212002'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_den) +'条' + ',完成' + string(ll_mole) +'条'
	f_save(dw_bb)
next
f_Save(dw_zbfjygr)

f_logger(this.text + ' 已执行')
end event

type cb_gwydwclv from uo_commandbutton within wzr_automsg
integer x = 3707
integer y = 1816
integer width = 549
integer height = 84
integer taborder = 40
boolean bringtotop = true
string text = "岗位异动跟进完成率"
end type

event clicked;call super::clicked;datetime ldt_start,ldt_end
long month,year,i,j,ll_mole,ll_den,ll_find
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230212001',string(year))
dw_grzrr.retrieve('20230212001',string(year))
dw_zbfjy.retrieve('20230212001',string(year))
dw_zbfjygr.retrieve('20230212001',string(year))
dw_bb.retrieve('20230212001')
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_rzgj_autozb_changejob'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
//公司层面
for i = 1 to dw_gszrr.rowcount()
	string ls_zrr,ls_name
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	ll_den = dst.rowcount()
	ll_mole = 0
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
next
f_Save(dw_zbfjy)
//个人层面
for i = 1 to dw_grzrr.rowcount()
	ls_zrr = dw_grzrr.object.zb_zrr[i]
	ls_name = getname(ls_zrr)
	dst.setfilter( " sjwcr = '" + ls_zrr + "'")
	dst.filter()
	ll_den = dst.rowcount()
	ll_mole = 0
	dst.setfilter(" sjwcr = '" + ls_zrr + "'")
	dst.filter()
	for j = 1 to dst.rowcount()
		if dst.object.status[j] = 1 then
			ll_mole ++
		end if
	next
	if ll_den > 0 then
		ldc_lv = ll_mole/ll_den * 100
	else
		ldc_lv = 0
	end if
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230212001' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230212001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230212001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_den) +'条' + ',完成' + string(ll_mole) +'条'
	f_save(dw_bb)
next
f_Save(dw_zbfjygr)

f_logger(this.text + ' 已执行')
end event

type dw_bzbfjy from uo_datawindow within wzr_automsg
integer y = 116
integer width = 690
integer height = 556
integer taborder = 20
boolean bringtotop = true
string title = "部门"
string dataobject = "dwn_zbfjyb"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_mspfdclv from uo_commandbutton within wzr_automsg
integer x = 3547
integer y = 156
integer width = 549
integer taborder = 30
boolean bringtotop = true
string text = "面试评分达成率(新)"
end type

event clicked;call super::clicked;date ldt_today
datetime ldt_start,ldt_end
long month,day,year,startmonth,startyear,endyear,endmonth,i
long ll_jhmscnt,ll_sjmscnt,ll_find,ll_find1,ll_fz,ll_fm
dec{2} ldc_mspfdclv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
datastore fm
fm = create datastore
fm.dataobject = 'dwzr_interviewfm_auto'
fm.settransobject(sqlca)
fm.retrieve(ldt_start,ldt_end)

datastore fm1
fm1 = create datastore
fm1.dataobject = 'dwzr_interviewfm1_auto'
fm1.settransobject(sqlca)
fm1.retrieve(ldt_start,ldt_end)

datastore fz
fz = create datastore
fz.dataobject = 'dwzr_interviewfz_auto'
fz.settransobject(sqlca)
fz.retrieve(ldt_start,ldt_end)

datastore fz1
fz1 = create datastore
fz1.dataobject = 'dwzr_interviewfz1_auto'
fz1.settransobject(sqlca)
fz1.retrieve(ldt_start,ldt_end)

ll_fz = fz.rowcount() + fz1.rowcount()
ll_fm = fm.rowcount() + fm1.rowcount()
if ll_fm > 0 then
	ldc_mspfdclv = ll_fz / ll_fm * 100
else
	ldc_mspfdclv = 0
end if

//公司层面
dw_gszrr.retrieve('20220824001',string(year))
dw_zbfjy.retrieve('20220824001',string(year))
for i = 1 to dw_gszrr.rowcount()
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "'and zb_zrr = '" + dw_gszrr.object.zb_zrr[i] + "'",1,dw_zbfjy.rowcount())
	dw_zbfjy.object.zb_sjzz[ll_find] = ldc_mspfdclv
	long ll_int
	dec{2} ldc_mbz
	string ls_month,ls_name,ls_bbbh
	dw_bb.retrieve('20220824001')
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20220824001' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20220824001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = '000254'
	dw_bb.object.zb_xh[ll_int] = '20220824001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_mspfdclv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_fm) +'份' + ',完成' + string(ll_fz) +'份'
	f_save(dw_bb)
next
f_save(dw_zbfjy)




//个人层面
dw_zbfjygr.retrieve('20220824001',string(year))
datastore dst
dec{2} ldc_lv
dst = create datastore
dst.dataobject = 'dwzr_interviewer_pfbb1'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
for i = 1 to dst.rowcount()
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "'and zb_zrr = '" + dst.object.job_num[i] + "'",1,dw_zbfjygr.rowcount())
	if ll_find > 0 then
		ldc_lv = dst.object.compute_2[i] * 100
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
next
f_save(dw_zbfjygr)



f_logger(this.text + ' 已执行')




end event

type cb_mspfjslv from uo_commandbutton within wzr_automsg
integer x = 3520
integer y = 264
integer width = 603
integer taborder = 40
boolean bringtotop = true
string text = "面试评分及时率（新）"
end type

event clicked;call super::clicked;date ldt_today
datetime ldt_start,ldt_end
long month,day,year,startmonth,startyear,endyear,endmonth
long ll_jhmscnt,ll_sjmscnt,ll_find,ll_fm,ll_fz,i
dec{2} ldc_mspfdclv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))

datastore fm
fm = create datastore
fm.dataobject = 'dwzr_interviewfm_auto'
fm.settransobject(sqlca)
fm.retrieve(ldt_start,ldt_end)

datastore fm1
fm1 = create datastore
fm1.dataobject = 'dwzr_interviewfm1_auto'
fm1.settransobject(sqlca)
fm1.retrieve(ldt_start,ldt_end)

datastore fz
fz = create datastore
fz.dataobject = 'dwzr_interviewfz_auto'
fz.settransobject(sqlca)
fz.retrieve(ldt_start,ldt_end)
fz.setfilter("diff <= 15")
fz.filter()

datastore fz1
fz1 = create datastore
fz1.dataobject = 'dwzr_interviewfz1_js_auto'
fz1.settransobject(sqlca)
fz1.retrieve(ldt_start,ldt_end)

ll_fz = fz.rowcount() + fz1.rowcount()
ll_fm = fm.rowcount() + fm1.rowcount()
if ll_fm > 0 then
	ldc_mspfdclv = ll_fz / ll_fm * 100
else
	ldc_mspfdclv = 0
end if


//公司层面
dw_gszrr.retrieve('20220824002',string(year))
dw_zbfjy.retrieve('20220824002',string(year))
for i = 1 to dw_gszrr.rowcount()
	ll_find = dw_zbfjy.find("zb_month = '" + string(month) + "'and zb_zrr = '" + dw_gszrr.object.zb_zrr[i] + "'",1,dw_zbfjy.rowcount())
	dw_zbfjy.object.zb_sjzz[ll_find] = ldc_mspfdclv
	
	long ll_int
	dec{2} ldc_mbz
	string ls_month,ls_name,ls_bbbh
	dw_bb.retrieve('20220824002')
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20220824002' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20220824002';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = '000254'
	dw_bb.object.zb_xh[ll_int] = '20220824002'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_mspfdclv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_fm) +'份' + ',完成' + string(ll_fz) +'份'
	f_save(dw_bb)
next
f_save(dw_zbfjy)


//个人层面
dw_zbfjygr.retrieve('20220824002',string(year))
datastore dst
dec{2} ldc_lv
dst = create datastore
dst.dataobject = 'dwzr_interviewer_pfbb1'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
for i = 1 to dst.rowcount()
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "'and zb_zrr = '" + dst.object.job_num[i] + "'",1,dw_zbfjygr.rowcount())
	if ll_find > 0 then
		ldc_lv = dst.object.compute_3[i] * 100
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
next
f_save(dw_zbfjygr)
f_logger(this.text + ' 已执行')
end event

type dw_oec from uo_datawindow within wzr_automsg
integer x = 3113
integer width = 384
integer height = 224
integer taborder = 20
string dataobject = "dw_oecdclear"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_meal from commandbutton within wzr_automsg
integer x = 2848
integer y = 1308
integer width = 402
integer height = 84
integer taborder = 40
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "就餐采购统计"
end type

event clicked;string ls_time,ls_date
ls_time = string(now(),'hh:mm')
long ll_find,ins
//中餐预计划
if ls_time = '08:30' then
	ls_date = string(today(),'yyyy-mm-dd')
	f_ygqx(ls_date)
	if dw_qxb.rowcount() > 0 then
		dw_meal.retrieve()
		ll_find = dw_meal.find("string(date,'yyyy-mm-dd') = '" + ls_date + "'",1,dw_meal.rowcount())
		if ll_find > 0 then
			ins = ll_find
		else
			ins = dw_meal.insertrow(0)
		end if
		dw_meal.object.dayofweek[ins] = string(daynumber(date(ls_date)))
		dw_meal.object.date[ins] = datetime(date(ls_date),time('00:00:00'))
		dw_meal.object.lunch_num8[ins] = dw_qxb.object.lunch[1]
	end if
end if

//实际中餐
if ls_time = '13:00' then
	ls_date = string(today(),'yyyy-mm-dd')
	f_ygqx(ls_date)
	if dw_qxb.rowcount() > 0 then
		dw_meal.retrieve()
		ll_find = dw_meal.find("string(date,'yyyy-mm-dd') = '" + ls_date + "'",1,dw_meal.rowcount())
		if ll_find > 0 then
			ins = ll_find
		else
			ins = dw_meal.insertrow(0)
		end if
		dw_meal.object.dayofweek[ins] = string(daynumber(date(ls_date)))
		dw_meal.object.date[ins] = datetime(date(ls_date),time('00:00:00'))
		dw_meal.object.lunch_num15[ins] = dw_qxb.object.sjlunch[1]
	end if
	
	f_mealerroperson(1)	
end if

//晚餐预计划
if ls_time = '15:00' then
	ls_date = string(today(),'yyyy-mm-dd')
	f_ygqx(ls_date)
	if dw_qxb.rowcount() > 0 then
		dw_meal.retrieve()
		ll_find = dw_meal.find("string(date,'yyyy-mm-dd') = '" + ls_date + "'",1,dw_meal.rowcount())
		if ll_find > 0 then
			ins = ll_find
		else
			ins = dw_meal.insertrow(0)
		end if
		dw_meal.object.dayofweek[ins] = string(daynumber(date(ls_date)))
		dw_meal.object.date[ins] = datetime(date(ls_date),time('00:00:00'))
		dw_meal.object.dinner_num8[ins] = dw_qxb.object.dinner[1]
	end if
end if

if ls_time = '18:30' then
	//先执行当天的实际晚餐统计
	ls_date = string(today(),'yyyy-mm-dd')
	f_ygqx(ls_date)
	if dw_qxb.rowcount() > 0 then
		dw_meal.retrieve()
		ll_find = dw_meal.find("string(date,'yyyy-mm-dd') = '" + ls_date + "'",1,dw_meal.rowcount())
		if ll_find > 0 then
			ins = ll_find
		else
			ins = dw_meal.insertrow(0)
		end if
		dw_meal.object.dayofweek[ins] = string(daynumber(date(ls_date)))
		dw_meal.object.date[ins] = datetime(date(ls_date),time('00:00:00'))
		dw_meal.object.dinner_num15[ins] = dw_qxb.object.sjdinner[1]
	end if
	f_save(dw_meal)
	//第二天的采购计划
	ls_date = string(Relativedate(today(),1),'yyyy-mm-dd')
	f_ygqx(ls_date)
	if dw_qxb.rowcount() > 0 then
		dw_meal.retrieve()
		ll_find = dw_meal.find("string(date,'yyyy-mm-dd') = '" + ls_date + "'",1,dw_meal.rowcount())
		if ll_find > 0 then
			ins = ll_find
		else
			ins = dw_meal.insertrow(0)
		end if
		dw_meal.object.dayofweek[ins] = string(daynumber(date(ls_date)))
		dw_meal.object.date[ins] = datetime(date(ls_date),time('00:00:00'))
		dw_meal.object.employee_num[ins] = dw_qxb.rowcount()
		dw_meal.object.lunch_num[ins] = dw_qxb.object.lunch[1]
		dw_meal.object.dinner_num[ins] = dw_qxb.object.dinner[1]
	end if
	
	f_mealerroperson(0)
	
end if



f_save(dw_meal)

end event

type dw_meal from datawindow within wzr_automsg
integer x = 2363
integer y = 2148
integer width = 686
integer height = 400
integer taborder = 30
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_census_meal"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;this.settransobject(sqlca)
end event

type dw_qxb from datawindow within wzr_automsg
integer x = 2345
integer y = 2412
integer width = 754
integer height = 460
integer taborder = 60
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_ygqxb"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;this.settransobject(sqlca)
end event

type st_5 from statictext within wzr_automsg
integer x = 2711
integer y = 864
integer width = 174
integer height = 68
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
long textcolor = 33554432
long backcolor = 67108864
string text = "薪酬："
boolean focusrectangle = false
end type

type cb_rydx from uo_commandbutton within wzr_automsg
integer x = 2757
integer y = 936
integer width = 549
integer taborder = 30
boolean bringtotop = true
string text = "人员定薪审核绩效能"
end type

event clicked;call super::clicked;datastore dst
long i
dst = create datastore
dst.dataobject = 'dwzr_xcxq_personallist'
dst.settransobject(sqlca)
dst.retrieve()
datetime ldt_start
long ll_xh
string ls_bh,ls_jrsx
ldt_start = datetime(today(),time('00:00:00'))
for i = 1 to dst.rowcount()
	string ls_ygid
	ls_jrsx = dst.object.xqdh[i] + '-' + dst.describe("Evaluate('LookupDisplay(associated_post)',"+string(i)+")") + '-' + dst.object.person[i] + '定薪审核'
	ls_ygid = dst.object.shr[i]
	select max(xh) into :ll_xh from jxjjgl where rq = :ldt_start and ygid = :ls_ygid;
	if isnull(ll_xh) then
		ll_xh = 1 
	else
		ll_xh = ll_xh + 1
	end if
	ls_bh = string(ldt_start,"yyyymmdd") + ls_ygid + string(ll_xh)
	INSERT INTO jxjjgl(qsj,zsj,jrsx,rq,ygid,xh,wc,tdrq,bh,bhbj,fzs)
	VALUES (:ldt_start,:ldt_start,:ls_jrsx,:ldt_start,:ls_ygid,:ll_xh,"0",:ldt_start,:ls_bh,"0",20);
	fc_sqlcode0()
next 
f_logger(this.text + ' 已执行')
end event

type cb_rfm from uo_commandbutton within wzr_automsg
integer x = 4311
integer y = 764
integer taborder = 30
boolean bringtotop = true
string text = "RFM模型"
end type

event clicked;call super::clicked;datetime ldt_today
long i,j,ins
string ls_jc
ldt_today = datetime(today(),time('00:00:00'))
datastore rfm,cyfs,rfm_a
rfm = create datastore
rfm.dataobject = 'dwzr_mbkhq_rfmmodel1'
rfm.settransobject(sqlca)


cyfs = create datastore
cyfs.dataobject = 'dwzr_cyfs_auto'
cyfs.settransobject(sqlca)
cyfs.retrieve( )
for i = 1 to cyfs.rowcount()
	ls_jc = cyfs.object.jc[i]
// if i < 3 then
	rfm.retrieve(ldt_today,ls_jc + '%')
//	rfm.retrieve(ldt_today,'JK%')
	for j = 1  to rfm.rowcount( )
		ins = dw_rfm.insertrow(0)
		dw_rfm.object.day[ins] = ldt_today
		dw_rfm.object.cyfs[ins] = ls_jc
		dw_rfm.object.khdh[ins] = rfm.object.khdh[j]
		dw_rfm.object.khbh[ins] = rfm.object.khbh[j]
		dw_rfm.object.latest_time[ins] = rfm.object.latest_time[j]
		dw_rfm.object.fhdw[ins] = rfm.object.fhdw[j]
		dw_rfm.object.wl_frequency1[ins] = rfm.object.one[j]
		dw_rfm.object.wl_frequency3[ins] = rfm.object.three[j]
		dw_rfm.object.wl_frequency6[ins] = rfm.object.six[j]
		dw_rfm.object.wl_frequency12[ins] = rfm.object.one_year[j]
		dw_rfm.object.transport_fee1[ins] = rfm.object.fee1[j]
		dw_rfm.object.transport_fee3[ins] = rfm.object.fee3[j]
		dw_rfm.object.transport_fee6[ins] = rfm.object.fee6[j]
		dw_rfm.object.transport_fee12[ins] = rfm.object.fee12[j]
		dw_rfm.object.rq[ins] = rfm.object.rq[j]
	next
//	end if
	f_save(dw_rfm)
next
f_logger(this.text + ' 已执行')
end event

type dw_rfm from datawindow within wzr_automsg
integer x = 5330
integer y = 1192
integer width = 686
integer height = 400
integer taborder = 40
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_rfm_model"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type cb_1 from commandbutton within wzr_automsg
integer x = 5367
integer y = 152
integer width = 713
integer height = 80
integer taborder = 30
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
boolean enabled = false
string text = "历史客户定义(分承运方式)"
end type

event clicked;datetime ldt_today
long i,j,ins,year,m,n,ll_find
string ls_jc,ls_midtime,ls_rfm
datastore rfm,cyfs,rfm_a
rfm = create datastore
rfm.dataobject = 'dwzr_mbkhq_rfmmodel1'
rfm.settransobject(sqlca)


cyfs = create datastore
cyfs.dataobject = 'dwzr_cyfs_auto'
cyfs.settransobject(sqlca)
cyfs.retrieve( )

dw_customer.dataobject = 'dwzr_rfm_customer_definition_uncyfs'
dw_customer.settransobject(sqlca)
dw_customer.retrieve()
for year = 2013 to 2022
//	if year = 2014 then
	ldt_today = datetime(date(string(year) + '-12-21'),time('00:00:00'))
	for i = 1 to cyfs.rowcount()
		ls_jc = cyfs.object.jc[i]
		//if i = cyfs.rowcount() then
		rfm.retrieve(ldt_today,ls_jc + '%')
		ls_midtime = f_midtime(rfm)
		long ll_c 
		ll_c = rfm.rowcount()
		for j = 1  to rfm.rowcount( )
			ls_rfm = ''
			ll_find = dw_customer.find("khbh = '" + rfm.object.khbh[j] +"' and cyfs = '" + ls_jc + "'",1,dw_customer.rowcount())
			if ll_find = 0 then
				ll_find = dw_customer.insertrow(0)
				dw_customer.object.khbh[ll_find] = rfm.object.khbh[j]
				dw_customer.object.khqc[ll_find] = rfm.object.fhdw[j]
				dw_customer.object.cyfs[ll_find] = ls_jc
			end if
			//r
			if idt_mid <= rfm.object.latest_time[j] then
				ls_rfm = '高'
			else
				ls_rfm = '低'
			end if
			
			//m
			if rfm.object.fee1[j] >= rfm.object.compute_10[1] then
				m++
			end if
			if rfm.object.fee3[j] >= rfm.object.compute_11[1] then
				m++
			end if
			if rfm.object.fee6[j] >= rfm.object.compute_12[1] then
				m++
			end if
			if rfm.object.fee12[j] >= rfm.object.compute_13[1] then
				m++
			end if
			if m >= 2 then
				ls_rfm = ls_rfm + '高'
			else
				ls_rfm = ls_rfm + '低'
			end if
			
			//f
			if rfm.object.one[j] >= rfm.object.compute_3[1] then
				n++
			end if
			if rfm.object.three[j] >= rfm.object.compute_4[1] then
				n++
			end if
			if rfm.object.six[j] >= rfm.object.compute_5[1] then
				n++
			end if
			if rfm.object.one_year[j] >= rfm.object.compute_6[1] then
				n++
			end if
			if n >= 2 then
				ls_rfm = ls_rfm + '高'
			else
				ls_rfm = ls_rfm + '低'
			end if
			dw_customer.setitem(ll_find,'khdy_' + string(year),ls_rfm)
		next
	next
//end if
next
f_save(dw_customer)

end event

type dw_customer from datawindow within wzr_automsg
integer x = 4594
integer y = 1724
integer width = 736
integer height = 172
integer taborder = 60
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_rfm_customer_definition"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type cb_ygg from commandbutton within wzr_automsg
integer x = 2871
integer y = 1412
integer width = 494
integer height = 84
integer taborder = 30
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "腰果工人每月生成"
end type

event clicked;messagebox("",string(day(today())))
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_user_ygg'
dst.settransobject(sqlca)
dst.retrieve()
long i,year,month,ll_max,ins,lunch,dinner
string ls_name
datetime ldt_date
for i = 1 to dst.rowcount()
	if i = dst.rowcount() then
		ls_name = ls_name + dst.object.ygxm[i]
	else
		ls_name = ls_name + dst.object.ygxm[i] + "、"
	end if
next

lunch = dst.rowcount()
year = year(today())
month = month(today())
fzr_getmonthlastday(month,year,ll_max)
for i = 1 to ll_max
	ldt_date = datetime(date(string(year) + '-' + string(month) + '-' + string(i)),time('00:00:00'))
	ins = dw_ygg.insertrow(0)
	dw_ygg.object.date[ins] = ldt_date
	if daynumber(date(ldt_date)) = 1 then
		dw_ygg.object.persons[ins] = ''
		dw_ygg.object.lunch[ins] = 0
		dw_ygg.object.dinner[ins] = 0
	else
		dw_ygg.object.persons[ins] = ls_name
		dw_ygg.object.lunch[ins] = lunch
		dw_ygg.object.dinner[ins] = 0
	end if
next

f_save(dw_ygg)
end event

type dw_ygg from datawindow within wzr_automsg
integer x = 2034
integer y = 2540
integer width = 443
integer height = 220
integer taborder = 40
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_ygg_meal"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;this.settransobject(sqlca)
end event

type dw_menu from uo_datawindow within wzr_automsg
integer x = 2217
integer y = 2232
integer taborder = 20
boolean bringtotop = true
string dataobject = "dwzr_canteen_menu"
boolean hscrollbar = true
boolean vscrollbar = true
end type

type cb_2 from commandbutton within wzr_automsg
integer x = 5362
integer y = 56
integer width = 713
integer height = 80
integer taborder = 40
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
boolean enabled = false
string text = "历史客户定义"
end type

event clicked;datetime ldt_today
long i,j,ins,year,m,n,ll_find
string ls_jc,ls_midtime,ls_rfm
datastore rfm,cyfs,rfm_a
rfm = create datastore
rfm.dataobject = 'dwzr_mbkhq_rfmmodel3'
rfm.settransobject(sqlca)
dw_customer.dataobject = 'dwzr_rfm_customer_definition'
dw_customer.settransobject(sqlca)
dw_customer.retrieve()
for year = 2013 to 2022
	//if year = 2022 then
	ldt_today = datetime(date(string(year) + '-12-21'),time('00:00:00'))
	rfm.retrieve(ldt_today)
	ls_midtime = f_midtime(rfm)
	long ll_c 
	ll_c = rfm.rowcount()
	for j = 1  to rfm.rowcount( )
		ls_rfm = ''
		ll_find = dw_customer.find("khbh = '" + rfm.object.khbh[j] +"' and cyfs = '" + ls_jc + "'",1,dw_customer.rowcount())
		if ll_find = 0 then
			ll_find = dw_customer.insertrow(0)
			dw_customer.object.khbh[ll_find] = rfm.object.khbh[j]
			dw_customer.object.khqc[ll_find] = rfm.object.fhdw[j]
			dw_customer.object.cyfs[ll_find] = ls_jc
		end if
		//r
		if idt_mid <= rfm.object.latest_time[j] then
			ls_rfm = '高'
		else
			ls_rfm = '低'
		end if
		
		//m
		if rfm.object.fee1[j] >= rfm.object.compute_10[1] then
			m++
		end if
		if rfm.object.fee3[j] >= rfm.object.compute_11[1] then
			m++
		end if
		if rfm.object.fee6[j] >= rfm.object.compute_12[1] then
			m++
		end if
		if rfm.object.fee12[j] >= rfm.object.compute_13[1] then
			m++
		end if
		if m >= 2 then
			ls_rfm = ls_rfm + '高'
		else
			ls_rfm = ls_rfm + '低'
		end if
		
		//f
		if rfm.object.one[j] >= rfm.object.compute_3[1] then
			n++
		end if
		if rfm.object.three[j] >= rfm.object.compute_4[1] then
			n++
		end if
		if rfm.object.six[j] >= rfm.object.compute_5[1] then
			n++
		end if
		if rfm.object.one_year[j] >= rfm.object.compute_6[1] then
			n++
		end if
		if n >= 2 then
			ls_rfm = ls_rfm + '高'
		else
			ls_rfm = ls_rfm + '低'
		end if
		dw_customer.setitem(ll_find,'khdy_' + string(year),ls_rfm)
	next
//end if
next
f_save(dw_customer)

end event

type st_6 from statictext within wzr_automsg
integer x = 27
integer y = 2344
integer width = 293
integer height = 60
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
long textcolor = 33554432
long backcolor = 67108864
string text = "薪酬："
boolean focusrectangle = false
end type

type cb_gwpgwclv from commandbutton within wzr_automsg
string tag = "20230313001"
integer x = 41
integer y = 2424
integer width = 439
integer height = 84
integer taborder = 40
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "岗位评估完成率"
end type

event clicked;long ll_fz,ll_fm,year,month
datetime ldt_start,ldt_end
dec{2} ldc_lv
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230313001',string(year))
dw_zbfjy.retrieve('20230313001',string(year))
select count(id) into :ll_fm from job_name where job_name.shbz = 1;
SELECT count(job_id) into :ll_fz from rl_xc_pf where year(rl_xc_pf.lrsj) = :year;

if ll_fm = 0 or ll_fz = 0 then
	ldc_lv = 0
else
	ldc_lv = ll_fz/ll_fm*100
end if
string ls_zrr
long ll_find,i
for i = 1 to dw_gszrr.rowcount()
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ll_find = dw_zbfjy.find("zb_zrr = '" + ls_zrr + "' and zb_month = '" + string(month) + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh,ls_name
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230313001' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230313001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230313001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_fm) +'条' + ',完成' + string(ll_fz) +'条'
	f_save(dw_bb)
next
f_save(dw_zbfjy)


f_logger(this.text + ' 已执行')


end event

type cb_xcszwclv from commandbutton within wzr_automsg
string tag = "20230318002"
integer x = 32
integer y = 2744
integer width = 549
integer height = 84
integer taborder = 50
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "薪酬设置完成率"
end type

event clicked;long ll_fz,ll_fm,year,month
datetime ldt_start,ldt_end
dec{2} ldc_lv
string ls_zrr
long ll_find,i
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230318002',string(year))
dw_zbfjy.retrieve('20230318002',string(year))
datastore fz
fz = create datastore
fz.dataobject = 'dwzr_xcsz_hz'
fz.settransobject(sqlca)
fz.retrieve(string(year))
for i = 1 to fz.rowcount()
	if fz.object.zsbz[i] > 0 or fz.object.sybz[i] > 0 then
		ll_fz++
	end if
next
SELECT count(job_num) into :ll_fm from user_name where user_name.zt = 1 or user_name.zt = 2;

if ll_fm = 0 or ll_fz = 0 then
	ldc_lv = 0
else
	ldc_lv = ll_fz/ll_fm*100
end if

for i = 1 to dw_gszrr.rowcount()
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ll_find = dw_zbfjy.find("zb_zrr = '" + ls_zrr + "' and zb_month = '" + string(month) + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh,ls_name
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230318002' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230318002';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230318002'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_fm) +'条' + ',完成' + string(ll_fz) +'条'
	f_save(dw_bb)
next
f_save(dw_zbfjy)


f_logger(this.text + ' 已执行')


end event

type cb_gwxcgcfjlv from commandbutton within wzr_automsg
string tag = "20230318001"
integer x = 41
integer y = 2592
integer width = 549
integer height = 84
integer taborder = 60
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "岗位薪酬构成分解率"
end type

event clicked;long ll_fz,ll_fm,year,month
datetime ldt_start,ldt_end
dec{2} ldc_lv
string ls_zrr
long ll_find,i
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
dw_gszrr.retrieve('20230318001',string(year))
dw_zbfjy.retrieve('20230318001',string(year))
datastore fz
fz = create datastore
fz.dataobject = 'dwzr_gwfj_summary'
fz.settransobject(sqlca)
fz.retrieve()
for i = 1 to fz.rowcount()
	if fz.object.monthly_salary[i] > 0 then
		ll_fz++
	end if
next
ll_fm = fz.rowcount()

if ll_fm = 0 or ll_fz = 0 then
	ldc_lv = 0
else
	ldc_lv = ll_fz/ll_fm*100
end if

for i = 1 to dw_gszrr.rowcount()
	ls_zrr = dw_gszrr.object.zb_zrr[i]
	ll_find = dw_zbfjy.find("zb_zrr = '" + ls_zrr + "' and zb_month = '" + string(month) + "'",1,dw_zbfjy.rowcount())
	if ll_find > 0 then
		dw_zbfjy.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh,ls_name
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230318001' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230318001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230318001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_fm) +'条' + ',完成' + string(ll_fz) +'条'
	f_save(dw_bb)
next
f_save(dw_zbfjy)


f_logger(this.text + ' 已执行')


end event

type cb_3 from commandbutton within wzr_automsg
integer x = 832
integer y = 2404
integer width = 402
integer height = 88
integer taborder = 40
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
boolean enabled = false
string text = "水印"
end type

event clicked;long i
dw_1.settransobject(sqlca)
dw_1.retrieve()
for i = 1  to dw_1.rowcount()
	string ls_filename,ls_scwjbh,ls_dir,ls_temp
	long ll_connect,ins
	ls_scwjbh = dw_1.object.scwjbh[i]
	ls_filename = dw_1.object.scwjlj[i]
	n_ftp = Create nvo_ftp
	if ls_filename <>""then
		
		//****************
		//如果存在则删除然后再从服务器上下载新的
		if FileExists(gs_path +  ls_filename) = true then
			filedelete(gs_path +  ls_filename)
		end if
		
		//保存成功把资料上传至服务器
		ll_connect = n_ftp.uf_ftpconnect(gs_ftp,gs_ftpu,gs_ftpp,21)
		if ll_connect = 0 then
			Messagebox(gs_messagebox_title,"服务器连接失败!请检查你的网络!")
			return
		end if
		
		//设置服务器database的路径
		n_ftp.uf_ftpsetcurrentdir("database")
		ls_dir = n_ftp.uf_ftpgetcurrentdir()
		ls_temp = ls_dir + '/' + ls_scwjbh + ".zip"
		//设置本地下载路径
		n_ftp.uf_setcurrentdir(gs_path + "image\")
		If n_ftp.uf_ftpgetfile(ls_temp,ls_scwjbh + ".zip") Then
			//下载成功解压
			uo_1.of_unzip(gs_path + "image\" +  ls_scwjbh + ".zip",gs_path + "image",0)
			//删除下载的东东
			filedelete(gs_path + "image\" +  ls_scwjbh + ".zip")
			//断开连接
			n_ftp.uf_internetclose()		
		else
			messagebox(gs_messagebox_title,"从服务器取文件失败!请检查网络!2")
			return
		end if
	end if
next


blob ls_response
string ls_url
int liResult
//ls_url="http://localhost:1986/"+ls_parm
ls_url="http://10.141.59.45:8080/twzl/doWaterMark"

OleObject lole_tenyear   //声明ole
lole_tenyear = CREATE oleobject
lole_tenyear.ConnectToNewObject("Microsoft.XMLHttp") //帮顶XMLhttp组件，我测过xp和win7都自带，不需安装任何辅助软件如.net环境
lole_tenyear.open ("GET",ls_url, false)    //参数解释请看：POST
lole_tenyear.setRequestHeader('If-Modified-Since', '0');//清除缓存
lole_tenyear.setRequestHeader ("Content-type", "application/x-msdownload;charset=utf-8")//application/raw   application/x-www-form-urlencoded
try
	lole_tenyear.send('')     //关键是这一步：如果你的https的环境没有安装浏览器的认证的根证书，一定会报错退出，如果你申请安装了verisign等权威机构发的根证书，用ie打开上面的https，就不会报红色警告（问你是不是继续）。但pb不会提示你是不是继续，直接报错退出。verisign的证书一年好像要1万-10万元的服务费。在这里你如果想测试一下，你可以把上面的https地址换成https://www.alipay.com/  (支付宝的)，不会报错的。注意：这里的证书及验证都是单向验证，不是双向的。
catch(runtimeerror er)
	messagebox('提示',"当前网址不存在，请确保服务器是否已开启！"+string(er)) 
end try  //关键是这一步：如果你的https的环境没有安装浏览器的认证的根证书，一定会报错退出，如果你申请安装了verisign等权威机构发的根证书，用ie打开上面的https，就不会报红色警告（问你是不是继续）。但pb不会提示你是不是继续，直接报错退出。verisign的证书一年好像要1万-10万元的服务费。在这里你如果想测试一下，你可以把上面的https地址换成https://www.alipay.com/  (支付宝的)，不会报错的。注意：这里的证书及验证都是单向验证，不是双向的。
ls_response = lole_tenyear.responseBody   //返回结果

if string(ls_response) = '1' then
	string ls_zip
	long ll_ret_zip
	for i = 1 to dw_1.rowcount()
		//获取图片路径
		ls_filename = gs_path + dw_1.object.scwjlj[i]
		setprofilestring(gs_ini_file, "system", "filename", ls_filename)
		
		if isnull(ls_filename) or len(ls_filename)=0 then return
		string ls_extensions,ls_picture,ls_name
		long ll_pos,ll_pos2,ll_find,ll_getrow
		//截取文件的拓展名
		ll_pos = pos(ls_filename,'.',1)
		ls_extensions = mid(ls_filename,ll_pos,len(ls_filename))
		//存入的路径
		ls_picture = dw_1.object.scwjlj[i]
		ls_name = dw_1.object.scwjbh[i]
		
		long li_FileNum
		li_FileNum = FileCopy (ls_filename ,gs_path + ls_picture, true)
		
		ls_zip = gs_path + "image\" + ls_name + ".zip"
		
		//保存成功把资料上传至服务器
		ll_connect = n_ftp.uf_ftpconnect(gs_ftp,gs_ftpu,gs_ftpp,21)
		if ll_connect = 0 then
			Messagebox(gs_messagebox_title,"服务器连接失败!请检查你的网络,确定网络无误后请和管理员联系!")
			return
		end if
		n_ftp.uf_ftpsetcurrentdir("database")
		
		
		ll_ret_zip = uo_1.of_zip(ls_zip,gs_path + ls_picture,0 )
		if ll_ret_zip  = 1 then
			if n_ftp.uf_ftpputfile(ls_zip,ls_name + ".zip") then
				//Messagebox(gs_messagebox_title,"保存成功!")
				//删除zip文件
				filedelete(ls_zip)
			else
				MessageBox(gs_messagebox_title,gs_path +ls_filename + "上传保存失败")
			end if
		else
			Messagebox(gs_messagebox_title,"压缩失败!")
		end if
	next
end if
end event

type dw_1 from datawindow within wzr_automsg
integer x = 745
integer y = 2532
integer width = 1225
integer height = 552
integer taborder = 70
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_addwatermark"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type uo_1 from uo_zip within wzr_automsg
boolean visible = false
integer x = 1792
integer y = 2268
integer width = 448
integer height = 244
integer taborder = 40
boolean bringtotop = true
end type

on uo_1.destroy
call uo_zip::destroy
end on

type cb_rzjdjslv from commandbutton within wzr_automsg
string tag = "20230328001"
integer x = 2715
integer y = 608
integer width = 549
integer height = 84
integer taborder = 30
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "任职基数鉴定及时率"
end type

event clicked;datetime ldt_start,ldt_end
long month,year,ll_fm,ll_fz
f_getkpi(ldt_start,ldt_end,month)
year = year(date(ldt_end))
datastore dst
dst = create datastore
dst.dataobject = 'dnft_rzjdgl'
dst.settransobject(sqlca)
dst.retrieve(ldt_start,ldt_end)
ll_fm = dst.rowcount()
long i
dec{2} ldc_lv
for i = 1 to dst.rowcount()
	if dst.object.compute_3[i] = '正常' then
		ll_fz ++
	end if
next
if ll_fm = 0 then
	ldc_lv = 0
else
	ldc_lv = ll_fz / ll_fm * 100
end if


dw_grzrr.retrieve('20230328001',string(year))
dw_zbfjygr.retrieve('20230328001',string(year))

for i = 1 to dw_grzrr.rowcount()
	string ls_zrr
	long ll_find
	ls_zrr = dw_grzrr.object.zb_zrr[i]
	ll_find = dw_zbfjygr.find("zb_month = '" + string(month) + "' and zb_zrr ='" + ls_zrr + "'",1,dw_zbfjygr.rowcount())
	if ll_find > 0 then
		dw_zbfjygr.object.zb_sjzz[ll_find] = ldc_lv
	end if
	
	long ll_int
	dec ldc_mbz
	string ls_month,ls_bbbh,ls_name
	ls_month = string(month)
	ll_int = dw_bb.insertrow(0)
	select top 1 zb_mbz into :ldc_mbz from zb_fjy where zb_xh = '20230328001' and zb_month = :ls_month and zb_year = :year;
	select zb_name into :ls_name from zb_jxb where zb_bh = '20230328001';
	select max(bbbh) into :ls_bbbh from zhj_bbzx where bbbh like 'BB%';
	ls_bbbh = 'BB' + string(long(mid(ls_bbbh,3,len(ls_bbbh))) + 1);
	dw_bb.object.bbbh[ll_int] = ls_bbbh
	dw_bb.object.job_num[ll_int] = ls_zrr
	dw_bb.object.zb_xh[ll_int] = '20230328001'
	dw_bb.object.mbz[ll_int] = ldc_mbz
	dw_bb.object.sjz[ll_int] = ldc_lv
	dw_bb.object.zbmc[ll_int] = ls_name
	dw_bb.object.dqsj[ll_int] = datetime(today(),now())
	dw_bb.object.qssj[ll_int] = ldt_start
	dw_bb.object.jssj[ll_int] = ldt_end
	dw_bb.object.bz[ll_int] = '总计需求' + string(ll_fm) +'条' + ',完成' + string(ll_fz) +'条'
	f_save(dw_bb)
next
f_save(dw_zbfjygr)
end event

type dw_jkdj from datawindow within wzr_automsg
integer x = 4521
integer y = 1964
integer width = 686
integer height = 400
integer taborder = 50
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_jkkydj_quoted_price"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type cb_jkdj from commandbutton within wzr_automsg
integer x = 4306
integer y = 904
integer width = 658
integer height = 84
integer taborder = 30
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "进口管理定价单失效提醒"
end type

event clicked;dw_jkdj.retrieve()
long i,j,ll_hdbh
string ls_djbh
datastore dst
dst = create datastore
dst.dataobject = 'dwzr_bd001700'
dst.settransobject(sqlca)
dst.retrieve()
if dw_jkdj.rowcount() > 0 then
	for i = 1 to dw_jkdj.rowcount()
		ls_djbh = dw_jkdj.object.djbh[i]
		ll_hdbh = dw_jkdj.object.hdbh[i]
		for j = 1 to dst.rowcount()
			string ls_wxid,ls_urlcd
			//ls_wxid = f_wxid("000393")
			ls_wxid = f_wxid(dst.object.m1[j])
			ls_urlcd = ''
			f_wxmsg("活动" + string(ll_hdbh) + "中有定价单即将失效，请前往修改。",ls_djbh,"定价信息",'1',"路径：进口管理-活动" + string(ll_hdbh) + "-营销管理-定价-空运定价",ls_wxid,ls_urlcd)
		next
	next
end if
end event

type dw_2 from datawindow within wzr_automsg
integer x = 3227
integer y = 2240
integer width = 686
integer height = 400
integer taborder = 50
boolean bringtotop = true
string title = "none"
string dataobject = "dwn_job"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type dw_3 from datawindow within wzr_automsg
integer x = 3177
integer y = 2576
integer width = 686
integer height = 400
integer taborder = 60
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_dr_job"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

type cb_4 from commandbutton within wzr_automsg
integer x = 3296
integer y = 2108
integer width = 402
integer height = 84
integer taborder = 50
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "none"
end type

event clicked;//long i,ins
//dw_2.retrieve()
//for i = 1 to dw_2.rowcount()
//	ins = dw_3.insertrow(0)
//	dw_3.object.jobid[ins] = dw_2.object.id[i]
//	dw_3.object.gwlx[ins] = dw_2.object.gwlx[i]
//	dw_3.object.this_gwbh[ins] = dw_2.object.gwbh[i]
//	if dw_2.object.gwlx[i] <> "1" then
//		dw_3.object.upper_gwbh[ins] = dw_2.object.job_name_gwbh1[i]
//	end if
//	dw_3.object.department[ins] = dw_2.object.department[i]
//next
//f_save(dw_3)
open(wzr_bdtable)
end event

type cb_pxjhtz from commandbutton within wzr_automsg
integer x = 2711
integer y = 728
integer width = 457
integer height = 84
integer taborder = 30
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = gb2312charset!
fontpitch fontpitch = variable!
string facename = "宋体"
string text = "培训计划通知"
end type

event clicked;if dw_pxtz.retrieve() > 0 then
	long i,j,ll_xh
	string ls_ry,ry[],ls_pxdd,ls_pxff,ls_name,ls_content1,ls_content2,ls_content3,ls_bh,ls_pxls
	datetime ldt_start,ldt_end,ldt_pxrq
	for i = 1 to dw_pxtz.rowcount()
		//先获取到每条培训计划的培训人员
		ls_ry = dw_pxtz.object.pxry[i]
		ldt_pxrq = dw_pxtz.object.pxsj[i]
		ldt_start = datetime(date(ldt_pxrq),time(dw_pxtz.object.tmqs[i]))
		ldt_end = datetime(date(ldt_pxrq),time(dw_pxtz.object.tmjs[i]))
		ls_pxdd = dw_pxtz.describe("Evaluate('LookupDisplay(pxdd)',"+string(i)+")")
		ls_pxff = dw_pxtz.describe("Evaluate('LookupDisplay(pxff)',"+string(i)+")")
		ls_name = dw_pxtz.object.rz_pxjs_class_name[i]
		ls_content1 = ls_pxdd + "参加'" + ls_name + "'的培训"
		ls_content2 = ls_pxdd + "授课'" + ls_name + "'的课程"
		ls_content3 = ls_pxdd + "组织'" + ls_name + "'的培训"
		ls_pxls = dw_pxtz.object.pxls[i]
		fc_split(ls_ry,",",ry[])
		for j = 1 to upperbound(ry) - 1 //去除最后一个空的
			//给培训人员添加绩效能日志
			f_inslog(ry[j],ldt_pxrq,ldt_start,ldt_end,ls_content1)
		next
		//给培训老师下达
		if dw_pxtz.object.pxff[i] = '1' or dw_pxtz.object.pxff[i] = '2' then
			f_inslog(ls_pxls,ldt_pxrq,ldt_start,ldt_end,ls_content2)
		end if
		f_inslog('000303',ldt_pxrq,ldt_start,ldt_end,ls_content3)
		f_inslog('000388',ldt_pxrq,ldt_start,ldt_end,ls_content3)
	next
end if
end event

type dw_pxtz from datawindow within wzr_automsg
integer x = 2679
integer y = 1588
integer width = 686
integer height = 400
integer taborder = 30
boolean bringtotop = true
string title = "none"
string dataobject = "dwzr_pxtz_auto"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
end event

